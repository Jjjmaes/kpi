# 兼职销售和兼职排版业务逻辑说明

## 一、角色体系说明

系统中有两种角色概念：

### 1. 系统用户角色（User.roles）
- **用途**：系统权限控制（登录、访问权限等）
- **位置**：`models/User.js`
- **当前角色**：`admin`, `finance`, `sales`, `pm`, `translator`, `reviewer`, `admin_staff`
- **特点**：需要系统账号才能登录

### 2. 项目成员角色（ProjectMember.role）
- **用途**：KPI计算和项目参与记录
- **位置**：`models/ProjectMember.js`
- **当前角色**：`translator`, `reviewer`, `pm`, `sales`, `admin_staff`, `part_time_sales`, `layout`
- **特点**：在项目中添加成员时指定，用于计算该成员在此项目中的KPI

## 二、兼职销售和兼职排版的业务逻辑

### 2.1 设计思路

**方案A：不需要系统账号（当前实现）**
- 兼职销售和排版员是外部人员
- 不需要登录系统
- 只需要在项目中添加为成员
- 系统自动计算KPI，财务人员可以查看和导出

**方案B：需要系统账号（推荐）**
- 兼职销售和排版员需要登录系统查看自己的KPI
- 需要在用户管理中创建账号
- 需要添加 `part_time_sales` 和 `layout` 到 User.roles

### 2.2 当前实现方式（方案A）

#### 兼职销售流程：
1. **项目创建时**：
   - 销售在项目表单中填写：
     - 启用兼职销售
     - 公司应收金额
     - 税率
   - 系统自动计算返还佣金

2. **添加项目成员**：
   - PM或管理员在项目中添加成员
   - 选择用户（可以是外部人员，但需要在系统中创建用户记录）
   - 选择角色为"兼职销售"
   - 系统会为该成员生成KPI记录

3. **KPI计算**：
   - 项目完成时，系统自动计算兼职销售佣金
   - 公式：`返还佣金 = (成交额 - 公司应收) - (成交额 - 公司应收) × 税率`
   - 生成KPI记录，角色为 `part_time_sales`

#### 兼职排版流程：
1. **项目创建/编辑时**：
   - PM在项目表单中填写：
     - 启用兼职排版
     - 选择排版员（从用户列表中选择）
     - 输入排版费用
   - 系统自动校验费用是否超过5%

2. **添加项目成员**：
   - 如果排版员还没有添加为项目成员，PM需要添加
   - 选择排版员用户
   - 选择角色为"兼职排版"
   - 系统会为该成员生成KPI记录

3. **KPI计算**：
   - 项目完成时，系统自动计算排版员KPI
   - KPI值 = 排版费用
   - 生成KPI记录，角色为 `layout`

### 2.3 数据流转

```
项目创建
  ↓
填写兼职销售/排版信息
  ↓
添加项目成员（选择用户 + 角色）
  ↓
项目完成
  ↓
系统自动计算KPI
  ↓
生成KPI记录（userId + role + kpiValue）
  ↓
财务查看/导出KPI报表
```

## 三、关键点说明

### 3.1 为什么兼职销售/排版需要添加为项目成员？

- **KPI记录需要关联用户**：KpiRecord 模型需要 userId 和 role
- **一人多岗支持**：同一个用户可以在不同项目中担任不同角色
- **历史追溯**：可以查看某个兼职销售/排版员参与的所有项目

### 3.2 用户账号问题

**当前情况**：
- 兼职销售和排版员需要在系统中创建用户记录（用于关联）
- 但他们的 User.roles 可以是空数组或其他角色
- 他们可能不需要登录系统（如果不需要查看KPI）

**如果需要登录查看KPI**：
- 需要在 User.roles 中添加 `part_time_sales` 和 `layout`
- 需要在前端用户创建表单中添加这两个选项
- 需要更新权限中间件（如果需要特殊权限）

## 四、推荐实现方案

### 方案：添加系统角色支持（推荐）

**理由**：
1. 兼职销售和排版员可能需要登录系统查看自己的KPI
2. 统一角色管理，便于权限控制
3. 更好的用户体验

**需要修改的地方**：
1. `models/User.js`：添加 `part_time_sales` 和 `layout` 到 roles enum
2. `public/app.js`：在用户创建表单中添加这两个角色选项
3. `middleware/auth.js`：如果需要特殊权限，添加权限检查

**不影响现有功能**：
- ProjectMember.role 已经支持这两个角色
- KPI计算逻辑已经实现
- 项目创建/编辑表单已经支持

## 五、完整业务流程示例

### 示例1：兼职销售项目

1. **创建用户**（如果需要登录）：
   - 管理员创建用户：张三
   - 角色：兼职销售（如果添加了系统角色）

2. **创建项目**：
   - 销售创建项目
   - 项目金额：100,000元
   - 启用兼职销售：
     - 公司应收：20,000元
     - 税率：10%
   - 系统自动计算：返还佣金 = (100,000 - 20,000) - (80,000 × 0.1) = 72,000元

3. **添加项目成员**：
   - PM添加成员：张三
   - 角色：兼职销售

4. **项目完成**：
   - PM标记项目完成
   - 系统自动生成KPI记录：
     - userId: 张三的ID
     - role: part_time_sales
     - kpiValue: 72,000

5. **查看KPI**：
   - 财务可以查看所有兼职销售的KPI
   - 如果张三有系统账号，可以登录查看自己的KPI

### 示例2：兼职排版项目

1. **创建用户**（如果需要登录）：
   - 管理员创建用户：李四
   - 角色：兼职排版（如果添加了系统角色）

2. **创建/编辑项目**：
   - PM创建或编辑项目
   - 项目金额：10,000元
   - 启用兼职排版：
     - 选择排版员：李四
     - 排版费用：400元
   - 系统校验：400 / 10,000 = 4% < 5% ✓

3. **添加项目成员**：
   - PM添加成员：李四
   - 角色：兼职排版

4. **项目完成**：
   - PM标记项目完成
   - 系统自动生成KPI记录：
     - userId: 李四的ID
     - role: layout
     - kpiValue: 400

5. **查看KPI**：
   - 财务可以查看所有排版员的KPI
   - 如果李四有系统账号，可以登录查看自己的KPI

## 六、总结

**当前实现**：
- ✅ 兼职销售和排版的项目级功能已完整实现
- ✅ KPI计算逻辑已实现
- ⚠️ 用户管理中没有这两个角色选项（如果需要登录）

**建议**：
- 添加 `part_time_sales` 和 `layout` 到 User.roles
- 在用户创建表单中添加这两个选项
- 这样兼职销售和排版员可以登录系统查看自己的KPI



