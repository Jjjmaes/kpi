# 报销管理功能实现方案

## 一、功能概述

为系统提供报销管理功能，允许专职人员申请报销，财务和管理员进行审批和支付管理。

### 1.1 申请人
- **专职人员**：`employmentType === 'full_time'` 的所有用户
- **包含角色**：admin、finance、pm、sales、translator、reviewer、layout、admin_staff
- **排除角色**：part_time_sales、part_time_translator（兼职人员不参与报销）

### 1.2 审批人
- **财务岗**（finance）
- **管理员**（admin）

### 1.3 功能模块
1. **报销申请**：创建报销申请、添加费用明细
2. **报销审批**：批准/拒绝申请、填写审批意见
3. **支付管理**：标记已支付、记录支付信息
4. **报销查询**：查看申请列表、筛选和搜索
5. **报销统计**：按类型、状态、时间统计（可选扩展）

---

## 二、数据模型设计

### 2.1 报销申请表（ExpenseRequest）

```javascript
{
  requestNumber: String,        // 申请编号（自动生成，如：EXP20250115001）
  expenseType: String,          // 费用类型：travel（差旅费）、meal（餐费）、transport（交通费）、office_supply（办公用品）、communication（通讯费）、other（其他）
  items: [{                     // 费用明细列表
    date: Date,                 // 费用日期
    amount: Number,             // 金额（元）
    description: String,         // 费用说明
    invoice: String,            // 发票号（可选）
    attachments: [String]       // 附件URL（发票照片等，可选）
  }],
  totalAmount: Number,          // 总金额（元）
  reason: String,              // 申请说明
  status: String,              // 状态：pending（待审批）、approved（已批准）、rejected（已拒绝）、paid（已支付）、cancelled（已取消）
  createdBy: ObjectId,          // 申请人
  approvedBy: ObjectId,        // 审批人（财务/管理员）
  approvedAt: Date,            // 审批时间
  approvalNote: String,        // 审批意见
  rejectReason: String,         // 拒绝原因
  payment: {                   // 支付信息
    paidBy: ObjectId,           // 支付人（财务）
    paidAt: Date,              // 支付时间
    paymentMethod: String,     // 支付方式
    note: String              // 支付备注
  },
  note: String,                // 备注
  cancelReason: String,        // 取消原因
  createdAt: Date,             // 创建时间
  updatedAt: Date             // 更新时间
}
```

**索引**：
- `{ requestNumber: 1 }` - 唯一索引
- `{ status: 1, createdAt: -1 }` - 按状态和日期查询
- `{ createdBy: 1, status: 1 }` - 按申请人和状态查询
- `{ approvedBy: 1, status: 1 }` - 按审批人和状态查询
- `{ expenseType: 1, createdAt: -1 }` - 按费用类型和日期查询

---

## 三、功能模块详细设计

### 3.1 报销申请

#### 3.1.1 创建报销申请
- **申请人**：专职人员
- **必填信息**：
  - 费用类型（下拉选择）
  - 费用明细（至少一条）：
    - 费用日期
    - 金额
    - 费用说明
  - 总金额（自动计算）
  - 申请说明
- **可选信息**：
  - 发票号
  - 附件（发票照片等）
  - 备注

#### 3.1.2 费用明细管理
- 支持添加多条费用明细
- 支持删除费用明细
- 自动计算总金额
- 每条明细包含：日期、金额、说明、发票号、附件

### 3.2 报销审批

#### 3.2.1 审批列表
- **查看人**：财务/管理员
- **显示内容**：
  - 申请编号
  - 费用类型
  - 总金额
  - 申请人
  - 申请日期
  - 状态
- **筛选条件**：
  - 状态（待审批、已批准、已拒绝、已支付、已取消）
  - 费用类型
  - 申请人（可选扩展）

#### 3.2.2 审批操作
- **批准申请**：
  - 填写审批意见（可选）
  - 更新状态为"已批准"
  - 通知申请人
- **拒绝申请**：
  - 填写拒绝原因（必填）
  - 更新状态为"已拒绝"
  - 通知申请人

### 3.3 支付管理

#### 3.3.1 标记已支付
- **操作人**：财务/管理员
- **前提条件**：申请状态为"已批准"
- **填写信息**：
  - 支付方式（可选）
  - 支付备注（可选）
- **更新信息**：
  - 状态更新为"已支付"
  - 记录支付人和支付时间
  - 通知申请人

### 3.4 报销查询

#### 3.4.1 我的申请（个人视角）
- **查看人**：申请人本人
- **显示内容**：自己提交的所有报销申请
- **筛选条件**：
  - 状态
  - 费用类型
  - 日期范围（可选扩展）

#### 3.4.2 待审批（财务/管理员视角）
- **查看人**：财务/管理员
- **显示内容**：所有待审批的报销申请
- **筛选条件**：
  - 费用类型
  - 申请人（可选扩展）

#### 3.4.3 申请详情
- **基本信息**：
  - 申请编号
  - 费用类型
  - 总金额
  - 申请人
  - 申请日期
  - 状态
  - 申请说明
- **费用明细**：
  - 明细列表（日期、金额、说明、发票号）
- **审批信息**：
  - 审批人、审批时间、审批意见/拒绝原因
- **支付信息**（如已支付）：
  - 支付人、支付时间、支付方式、支付备注

### 3.5 申请操作

#### 3.5.1 取消申请
- **操作人**：申请人本人
- **前提条件**：状态为"待审批"或"已拒绝"
- **操作**：
  - 填写取消原因（可选）
  - 更新状态为"已取消"

---

## 四、前端界面设计

### 4.1 导航菜单
- 在主导航中添加"报销管理"按钮
- 显示待审批数量徽章（财务/管理员可见）

### 4.2 主要页面

#### 4.2.1 报销管理页面
- **标签页**：
  - "我的申请"（所有用户）
  - "待审批"（财务/管理员）
- **筛选器**：
  - 状态筛选
  - 费用类型筛选
  - 每页显示数量
- **列表显示**：
  - 申请编号
  - 费用类型
  - 总金额
  - 申请人
  - 申请日期
  - 状态
  - 操作按钮

#### 4.2.2 创建申请表单
- **费用类型选择**：下拉选择框
- **费用明细区域**：
  - 动态添加/删除明细行
  - 每条明细包含：日期、金额、说明、发票号、附件上传
- **总金额**：自动计算，只读显示
- **申请说明**：多行文本输入
- **备注**：可选

#### 4.2.3 申请详情模态框
- **基本信息卡片**：申请编号、费用类型、总金额、申请人、申请日期、状态、申请说明、备注
- **审批信息卡片**（如有）：审批人、审批时间、审批意见/拒绝原因
- **支付信息卡片**（如已支付）：支付人、支付时间、支付方式、支付备注
- **费用明细表格**：序号、日期、金额、说明、发票号
- **操作按钮**：
  - 申请人：取消申请（仅pending/rejected状态）
  - 财务/管理员：批准/拒绝（pending状态）、标记已支付（approved状态）

---

## 五、后端API设计

### 5.1 报销申请API

```
POST   /api/expense                    # 创建报销申请
GET    /api/expense                    # 获取报销申请列表
GET    /api/expense/:id                # 获取报销申请详情
PUT    /api/expense/:id/approve        # 批准申请
PUT    /api/expense/:id/reject         # 拒绝申请
PUT    /api/expense/:id/pay            # 标记已支付
PUT    /api/expense/:id/cancel         # 取消申请
GET    /api/expense/pending/count      # 获取待审批数量
```

### 5.2 API详细说明

#### POST /api/expense
**请求体**：
```json
{
  "expenseType": "travel",
  "items": [
    {
      "date": "2025-01-15",
      "amount": 500.00,
      "description": "出差住宿费",
      "invoice": "INV001",
      "attachments": []
    }
  ],
  "totalAmount": 500.00,
  "reason": "出差报销",
  "note": "备注信息"
}
```

**响应**：
```json
{
  "success": true,
  "message": "报销申请已提交",
  "data": { /* ExpenseRequest对象 */ }
}
```

#### GET /api/expense
**查询参数**：
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认20）
- `status`: 状态筛选
- `expenseType`: 费用类型筛选
- `tab`: 标签页（my/approve）

**响应**：
```json
{
  "success": true,
  "data": {
    "requests": [ /* ExpenseRequest数组 */ ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

#### PUT /api/expense/:id/approve
**请求体**：
```json
{
  "approvalNote": "审批意见（可选）"
}
```

#### PUT /api/expense/:id/reject
**请求体**：
```json
{
  "rejectReason": "拒绝原因（必填）"
}
```

#### PUT /api/expense/:id/pay
**请求体**：
```json
{
  "paymentMethod": "银行转账（可选）",
  "note": "支付备注（可选）"
}
```

#### PUT /api/expense/:id/cancel
**请求体**：
```json
{
  "cancelReason": "取消原因（可选）"
}
```

---

## 六、权限控制

### 6.1 角色权限

| 功能 | 专职人员 | 财务/管理员 | 兼职人员 |
|------|---------|------------|---------|
| 创建报销申请 | ✅ | ✅ | ❌ |
| 查看自己的申请 | ✅ | ✅ | ❌ |
| 查看所有申请 | ❌ | ✅ | ❌ |
| 批准/拒绝申请 | ❌ | ✅ | ❌ |
| 标记已支付 | ❌ | ✅ | ❌ |
| 取消申请 | ✅（仅自己的） | ❌ | ❌ |

### 6.2 数据过滤
- **个人视角**：只能查看自己的申请
- **财务/管理员视角**：可以查看所有申请
- **待审批列表**：只显示状态为"pending"的申请

### 6.3 申请限制
- 只有专职人员（`employmentType === 'full_time'`）可以创建报销申请
- 兼职人员无法创建报销申请

---

## 七、通知机制

### 7.1 通知类型
- `EXPENSE_REQUEST`: 报销申请提交（通知财务/管理员）
- `EXPENSE_APPROVED`: 报销申请已批准（通知申请人）
- `EXPENSE_REJECTED`: 报销申请已拒绝（通知申请人）
- `EXPENSE_PAID`: 报销申请已支付（通知申请人）

### 7.2 通知触发时机
1. **申请提交**：通知所有财务和管理员
2. **申请批准**：通知申请人
3. **申请拒绝**：通知申请人
4. **标记已支付**：通知申请人

---

## 八、实现细节

### 8.1 申请编号生成规则
- 格式：`EXP{YYYYMMDD}{序号}`
- 示例：`EXP20250115001`、`EXP20250115002`
- 规则：按日期生成，同一天从001开始递增

### 8.2 总金额计算
- 前端自动计算：所有明细金额之和
- 后端验证：确保总金额与明细金额之和一致

### 8.3 状态流转
```
pending（待审批）
  ├─→ approved（已批准）→ paid（已支付）
  └─→ rejected（已拒绝）
  
pending/rejected → cancelled（已取消）
```

### 8.4 数据验证
- **创建申请时**：
  - 验证申请人是否为专职人员
  - 验证费用明细完整性
  - 验证总金额大于0
  - 验证申请说明不为空
- **审批时**：
  - 验证申请状态为"pending"
  - 拒绝时必须填写拒绝原因
- **支付时**：
  - 验证申请状态为"approved"

---

## 九、前端实现要点

### 9.1 费用明细动态添加
- 使用JavaScript动态创建DOM元素
- 支持添加/删除明细行
- 自动计算总金额

### 9.2 角色权限控制
- 基于`state.currentRole`判断权限
- 动态显示/隐藏功能按钮
- 动态显示/隐藏标签页

### 9.3 列表筛选
- 支持按状态筛选
- 支持按费用类型筛选
- 支持分页显示

### 9.4 待审批数量徽章
- 财务/管理员可见
- 实时更新待审批数量
- 显示在导航按钮和标签页上

---

## 十、扩展功能（可选）

### 10.1 附件上传
- **当前实现**：支持附件字段，但上传功能未实现
- **扩展方案**：
  - 使用文件上传服务（如云存储）
  - 支持图片和PDF格式
  - 限制文件大小和数量

### 10.2 报销统计
- **个人统计**：
  - 月度/年度报销总额
  - 按费用类型统计
  - 报销次数统计
- **全员统计**（财务/管理员）：
  - 部门/角色报销统计
  - 费用类型分析
  - 报销趋势分析

### 10.3 报销报表
- 生成月度/年度报销报表
- 支持导出Excel
- 包含明细和汇总信息

### 10.4 预算管理
- 设置报销预算
- 预算预警
- 预算执行情况跟踪

### 10.5 多级审批
- 根据金额设置审批流程
- 部门负责人审批
- 财务最终审批

---

## 十一、文件结构

```
models/
  ExpenseRequest.js          # 报销申请数据模型

routes/
  expense.js                 # 报销管理API路由

public/js/modules/
  expense.js                 # 报销管理前端模块

public/index.html
  - 添加"报销管理"导航按钮
  - 添加报销管理页面结构

server.js
  - 注册报销管理路由

services/notificationService.js
  - 添加报销相关通知类型
```

---

## 十二、测试要点

### 12.1 功能测试
- [ ] 专职人员可以创建报销申请
- [ ] 兼职人员无法创建报销申请
- [ ] 费用明细可以动态添加/删除
- [ ] 总金额自动计算正确
- [ ] 财务/管理员可以查看待审批列表
- [ ] 财务/管理员可以批准/拒绝申请
- [ ] 财务/管理员可以标记已支付
- [ ] 申请人可以取消自己的申请（仅pending/rejected状态）
- [ ] 通知正确发送

### 12.2 权限测试
- [ ] 专职人员只能查看自己的申请
- [ ] 财务/管理员可以查看所有申请
- [ ] 非财务/管理员无法访问"待审批"标签
- [ ] 非财务/管理员无法进行审批操作

### 12.3 数据验证测试
- [ ] 必填字段验证
- [ ] 金额验证（必须大于0）
- [ ] 费用明细验证
- [ ] 状态流转验证

---

## 十三、使用说明

### 13.1 专职人员申请报销

1. **进入报销管理**
   - 点击导航栏"报销管理"按钮

2. **创建申请**
   - 点击"新建申请"按钮
   - 选择费用类型
   - 添加费用明细：
     - 点击"添加明细"按钮
     - 填写费用日期、金额、说明
     - 可选填写发票号
   - 系统自动计算总金额
   - 填写申请说明
   - 可选填写备注
   - 点击"提交申请"

3. **查看申请状态**
   - 在"我的申请"标签页查看
   - 可以按状态、费用类型筛选
   - 点击"查看"查看详情

4. **取消申请**
   - 仅"待审批"或"已拒绝"状态的申请可以取消
   - 点击"取消"按钮
   - 填写取消原因（可选）

### 13.2 财务/管理员审批报销

1. **查看待审批列表**
   - 点击"报销管理" → "待审批"标签
   - 查看所有待审批的申请

2. **审批申请**
   - 点击"查看"查看申请详情
   - 点击"批准"或"拒绝"
   - 填写审批意见或拒绝原因
   - 确认操作

3. **标记已支付**
   - 对于"已批准"的申请
   - 点击"标记已支付"
   - 填写支付方式（可选）
   - 填写支付备注（可选）
   - 确认操作

---

## 十四、注意事项

1. **数据一致性**：确保总金额与明细金额之和一致
2. **权限控制**：严格验证申请人是否为专职人员
3. **状态流转**：确保状态流转符合业务规则
4. **通知发送**：通知发送失败不应影响主流程
5. **数据安全**：报销数据涉及财务，需要严格的权限控制
6. **历史记录**：报销记录一旦生成，修改需要审批流程

---

## 十五、后续优化建议

1. **附件上传功能**：实现发票照片等附件上传
2. **报销统计**：添加个人和全员报销统计功能
3. **报销报表**：生成和导出报销报表
4. **预算管理**：添加报销预算设置和预警
5. **多级审批**：根据金额设置多级审批流程
6. **移动端支持**：开发移动端报销申请功能

---

## 总结

本方案提供了完整的报销管理功能设计，包括数据模型、功能模块、API设计、权限控制等。实现时已参考办公用品采购模块的代码风格，保持系统一致性。

**核心特点**：
- ✅ 专职人员可申请，财务/管理员可审批
- ✅ 支持多条费用明细
- ✅ 完整的审批流程
- ✅ 支付管理功能
- ✅ 通知机制完善
- ✅ 权限控制严格

**当前状态**：✅ 已完整实现


