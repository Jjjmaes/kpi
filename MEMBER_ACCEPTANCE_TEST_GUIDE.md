# 成员接受/拒绝功能测试指南

## 一、前置准备

### 1.1 运行数据库迁移脚本

在实施功能后，需要先运行迁移脚本为现有数据设置默认值：

```bash
node migrations/add_member_acceptance.js
```

**迁移脚本会：**
- 为所有现有成员设置 `acceptanceStatus = 'accepted'`
- 为所有现有项目初始化 `memberAcceptance` 字段

### 1.2 重启服务器

确保所有代码更改已生效。

---

## 二、测试步骤

### 2.1 测试添加生产人员

1. **以项目经理（PM）身份登录**
2. **打开一个项目**（或创建新项目）
3. **添加生产人员**（翻译、审校、排版、兼职翻译）
4. **检查项目详情**：
   - 应该看到"确认进度"提示框
   - 新添加的生产人员应该显示"⏳ 待确认"状态

### 2.2 测试成员接受/拒绝

**重要：必须使用被添加的成员账号登录才能看到按钮！**

1. **退出当前账号**
2. **使用被添加的生产人员账号登录**
   - 例如：如果添加了"张三"作为翻译，需要用"张三"的账号登录
3. **打开项目详情**
4. **在项目成员列表中**：
   - 应该能看到自己的成员记录
   - 应该能看到"⏳ 待确认"状态
   - **应该能看到"接受"和"拒绝"按钮**

### 2.3 测试接受项目

1. **点击"接受"按钮**
2. **检查结果**：
   - 状态变为"✅ 已接受"
   - 显示接受日期
   - 项目经理收到通知
   - 如果所有生产人员都已接受，项目状态自动变为 `in_progress`

### 2.4 测试拒绝项目

1. **点击"拒绝"按钮**
2. **输入拒绝原因**（可选）
3. **检查结果**：
   - 状态变为"❌ 已拒绝"
   - 显示拒绝日期和原因
   - 项目经理收到通知
   - 项目状态保持 `scheduled`，等待重新安排

### 2.5 测试重新安排

1. **项目经理收到拒绝通知后**
2. **删除拒绝的成员**
3. **添加新成员**
4. **新成员需要重新确认**

---

## 三、常见问题排查

### 问题1：看不到接受/拒绝按钮

**可能原因：**
1. ❌ 使用了错误的账号登录（必须使用被添加的成员账号）
2. ❌ 成员状态不是 `pending`（可能是历史数据，默认是 `accepted`）
3. ❌ 成员角色不是生产人员（PM、销售等不需要确认）

**解决方法：**
- 确认使用的是被添加的成员账号登录
- 检查成员数据：在浏览器控制台查看 `project.members`，确认 `acceptanceStatus` 是否为 `'pending'`
- 确认成员角色是：`translator`、`reviewer`、`layout` 或 `part_time_translator`

### 问题2：按钮点击无反应

**可能原因：**
1. ❌ 函数未正确导出
2. ❌ 事件绑定问题

**解决方法：**
- 打开浏览器控制台，检查是否有错误
- 确认 `window.acceptMember` 和 `window.rejectMember` 函数存在
- 尝试直接在控制台调用：`acceptMember('projectId', 'memberId')`

### 问题3：成员状态显示不正确

**可能原因：**
1. ❌ 后端未正确设置 `acceptanceStatus`
2. ❌ 数据库迁移未运行

**解决方法：**
- 运行数据库迁移脚本
- 检查后端日志，确认添加成员时是否正确设置了状态
- 在数据库中直接查看 `projectmembers` 集合，确认 `acceptanceStatus` 字段

### 问题4：项目状态未自动变为 in_progress

**可能原因：**
1. ❌ 还有成员未接受
2. ❌ 某个角色有拒绝的成员，且没有重新安排
3. ❌ 某个角色没有有效成员（所有成员都被拒绝了，且没有重新安排）

**解决方法：**
- 检查所有生产角色是否都有有效成员（非拒绝的成员）
- 检查所有有效成员是否都已接受
- 如果有拒绝的成员，需要删除并重新添加新成员
- 系统会按角色分组检查，每个角色都需要有有效成员且都已接受

**状态判断逻辑：**
- 系统会检查每个生产角色（翻译、审校、排版、兼职翻译）
- 对于每个角色，如果曾经分配过，必须有有效的（非拒绝的）成员
- 所有有效成员都必须已接受
- 只有当所有角色都满足条件时，项目才会变为"进行中"

---

## 四、调试技巧

### 4.1 浏览器控制台调试

打开项目详情页后，在浏览器控制台执行：

```javascript
// 查看当前项目数据
console.log('项目数据:', currentProjectDetail);

// 查看成员数据
console.log('成员列表:', currentProjectDetail.members);

// 查看当前用户
console.log('当前用户:', state.currentUser);

// 检查成员接受状态
currentProjectDetail.members.forEach(m => {
    console.log(`成员: ${m.userId?.name || m.userId}, 角色: ${m.role}, 状态: ${m.acceptanceStatus}`);
});
```

### 4.2 后端日志检查

查看服务器日志，确认：
- 添加成员时是否正确设置了 `acceptanceStatus`
- 接受/拒绝接口是否被正确调用
- 是否有错误信息

### 4.3 数据库检查

在 MongoDB 中检查：

```javascript
// 查看项目成员
db.projectmembers.find({ projectId: ObjectId("项目ID") })

// 查看项目确认状态
db.projects.findOne({ _id: ObjectId("项目ID") }, { memberAcceptance: 1 })
```

---

## 五、功能验证清单

- [ ] 添加生产人员后，状态为 `pending`
- [ ] 添加非生产人员后，状态为 `accepted`（自动接受）
- [ ] 成员登录后能看到自己的待确认记录
- [ ] 成员能看到"接受"和"拒绝"按钮
- [ ] 点击"接受"后，状态变为 `accepted`，显示提示信息
- [ ] 点击"拒绝"后，状态变为 `rejected`，并显示原因，显示提示信息
- [ ] 项目经理和项目创建者收到接受/拒绝通知
- [ ] 所有生产角色都有有效成员且都已接受后，项目状态自动变为 `in_progress`
- [ ] 某个角色有拒绝的成员且没有重新安排时，项目不能进入 `in_progress`
- [ ] 拒绝后重新安排新成员，新成员接受后，项目可以进入 `in_progress`
- [ ] 项目完成前检查所有成员是否都已接受
- [ ] 多角色用户切换角色时，项目列表正确过滤
- [ ] 拒绝的成员不显示在项目列表中

---

## 六、注意事项

1. **必须使用被添加的成员账号登录**才能看到接受/拒绝按钮
2. **历史数据**：现有成员的 `acceptanceStatus` 默认为 `accepted`，不会显示按钮
3. **只有新添加的生产人员**才会显示待确认状态和按钮
4. **管理人员**（PM、销售等）自动接受，不需要确认

---

## 七、快速测试流程

1. **PM登录** → 添加翻译成员"张三"
2. **退出** → 用"张三"账号登录
3. **打开项目详情** → 应该看到"待确认"和"接受/拒绝"按钮
4. **点击"接受"** → 状态变为"已接受"
5. **PM登录** → 应该收到通知，项目状态变为 `in_progress`


