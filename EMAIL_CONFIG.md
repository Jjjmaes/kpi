# 邮件功能配置说明

## 一、环境变量配置

在 `.env` 文件中添加以下配置：

```env
# Resend 邮件服务配置
RESEND_API_KEY=re_xxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com
RESEND_FROM_NAME=语家 KPI 系统

# 应用 URL（用于邮件中的链接）
APP_URL=http://localhost:3000

# 邮件功能开关（可选，默认为 true）
EMAIL_ENABLED=true
```

### 配置说明

1. **RESEND_API_KEY**
   - 从 Resend 官网 (https://resend.com) 获取 API Key
   - 格式：`re_` 开头的字符串
   - 必需配置

2. **RESEND_FROM_EMAIL**
   - 发件人邮箱地址
   - 必须在 Resend 中验证的域名下
   - 必需配置

3. **RESEND_FROM_NAME**
   - 发件人显示名称
   - 可选，默认为 "语家 KPI 系统"

4. **APP_URL**
   - 应用访问地址
   - 用于邮件中的"查看项目详情"链接
   - 建议配置为生产环境地址

5. **EMAIL_ENABLED**
   - 邮件功能总开关
   - 设置为 `false` 可禁用所有邮件发送
   - 可选，默认为 `true`

## 二、Resend 设置步骤

1. **注册 Resend 账号**
   - 访问 https://resend.com
   - 注册并登录

2. **获取 API Key**
   - 进入 Dashboard → API Keys
   - 创建新的 API Key
   - 复制 Key 值到 `RESEND_API_KEY`

3. **验证域名**
   - 进入 Domains 页面
   - 添加你的域名（如 `yourdomain.com`）
   - 按照提示配置 DNS 记录
   - 验证成功后，可以使用该域名下的邮箱作为发件人

4. **测试发送**
   - 可以使用 Resend 的测试模式（无需验证域名）
   - 测试邮箱格式：`delivered@resend.dev`

## 三、依赖安装

如果 `package.json` 中没有 `resend` 依赖，需要安装：

```bash
npm install resend
```

## 四、功能说明

### 4.1 触发场景

邮件会在以下场景自动发送：

1. **创建项目时添加成员**
   - 在创建项目时批量添加成员，会批量发送邮件

2. **单独添加项目成员**
   - 通过"添加成员"功能添加单个成员时发送

### 4.2 邮件内容

邮件包含以下信息：
- 项目名称和编号
- 分配的角色
- 交付时间
- 源语种和目标语种
- 分配人信息
- 查看项目详情链接

### 4.3 错误处理

- 邮件发送失败不会影响项目成员分配流程
- 所有错误都会记录到控制台日志
- 如果用户没有邮箱，会跳过发送并记录警告

## 五、测试

### 5.1 测试邮件发送

1. 确保环境变量已正确配置
2. 启动服务器，检查日志中是否有 `[EmailService] 邮件服务已初始化`
3. 创建一个测试项目并添加成员
4. 检查成员邮箱是否收到邮件

### 5.2 测试配置缺失

如果配置不完整，系统会：
- 在启动时输出警告日志
- 跳过邮件发送，不影响其他功能
- 在控制台记录 `[EmailService] 邮件服务未启用，跳过发送`

## 六、日志查看

邮件发送相关的日志：

- **成功**：`[EmailService] 邮件发送成功: {...}`
- **失败**：`[EmailService] 邮件发送失败: {...}`
- **批量发送**：`[EmailService] 批量邮件发送完成: {...}`
- **配置问题**：`[EmailService] 邮件配置不完整，邮件功能已禁用`

## 七、故障排查

### 问题1：邮件未发送

**检查项：**
1. 环境变量是否正确配置
2. Resend API Key 是否有效
3. 发件人邮箱是否已验证域名
4. 用户是否有有效的邮箱地址
5. 查看服务器日志中的错误信息

### 问题2：邮件发送失败

**常见原因：**
- API Key 无效或过期
- 发件人邮箱未验证域名
- 收件人邮箱格式错误
- Resend 服务异常

**解决方法：**
- 检查 Resend Dashboard 中的错误日志
- 验证 API Key 和域名配置
- 查看服务器日志获取详细错误信息

### 问题3：邮件进入垃圾箱

**建议：**
- 确保域名已正确验证
- 配置 SPF、DKIM 等 DNS 记录（Resend 会提供）
- 使用专业的发件人邮箱地址

## 八、扩展功能

未来可以考虑添加：
- 邮件发送记录表（数据库存储）
- 用户邮件偏好设置
- 邮件模板管理
- 邮件发送队列（处理大量邮件）
- 其他类型的邮件通知（项目完成、回款到账等）

