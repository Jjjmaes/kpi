## 兼职专/兼测试说明（测试用例清单）

本测试文档用于验证：
- `employmentType` 专/兼职开关是否生效；
- 项目成员中专/兼职快照是否正确；
- 兼职销售分成与兼职排版费用的生成逻辑是否正确；
- 前端展示与报表是否一致。

---

### 一、前置条件

1. 至少一名管理员账号，可登录后台。
2. 已正常配置角色与权限（`sales`, `part_time_sales`, `layout`, `pm`, `finance` 等）。
3. 系统可正常创建项目并完成项目，KPI 生成流程已跑通。

---

### 二、用户管理：专/兼职字段测试

#### 用例 1：创建专职用户
- **步骤**
  1. 管理员登录 → 进入 `用户管理` → 点击 `创建用户`。
  2. 填写基础信息：用户名、密码、姓名、邮箱。
  3. 在“专/兼职”下拉选择 `专职`。
  4. 勾选角色（例如 `sales`），点击 `创建`。
- **预期**
  - 列表中出现新用户，`专/兼职` 列显示 `专职`。
  - 通过 API `/users` 返回结果中，该用户 `employmentType = 'full_time'`。

#### 用例 2：创建兼职用户
- **步骤**
  1. 同上，但“专/兼职”选择 `兼职`。
  2. 角色勾选 `part_time_sales` 或 `layout` 等。
- **预期**
  - 列表中该用户 `专/兼职` 列显示 `兼职`。
  - API 返回 `employmentType = 'part_time'`。

#### 用例 3：编辑用户修改专/兼职
- **步骤**
  1. 选中一个已有用户，点击 `编辑`。
  2. 将“专/兼职”从 `专职` 改为 `兼职`，点击 `更新`。
- **预期**
  - 列表中立即更新为 `兼职`。
  - 再次打开编辑弹窗，下拉框默认值为 `兼职`。

---

### 三、项目创建与成员专/兼职快照测试

#### 用例 4：创建项目并添加成员（专职销售 + 兼职销售 + 兼职排版）
- **步骤**
  1. 使用销售或 PM 账号，进入 `项目管理` → `创建项目`。
  2. 填写项目名称、客户、**项目金额**（如 100,000）。
  3. 在“兼职销售”区域（如果有），填写：
     - 公司应收：20,000
     - 税率：10%（0.1）
  4. 在“项目成员”区域：
     - 角色选择 `sales`，选择一个专职销售用户（`employmentType=full_time`），点击“添加成员”。
     - 角色选择 `part_time_sales`，选择一个兼职销售用户（`employmentType=part_time`），点击“添加成员”。
     - 角色选择 `layout`，选择一个兼职排版用户（`employmentType=part_time`），设置排版费用 400，点击“添加成员”。
  5. 保存项目。
- **预期**
  - “已添加成员”列表中每名成员显示：
    - `张三 - 销售 (专职)`
    - `王五 - 兼职销售 (兼职)`
    - `李四 - 兼职排版 (兼职) (费用: ¥400.00)`
  - 打开该项目的详情页，在“项目成员”块中，仍然展示上述专/兼职标识。

#### 用例 5：修改用户专/兼职后查看历史项目
- **步骤**
  1. 将用例 4 中的兼职销售用户在“用户管理”中改为 `专职`。
  2. 再次打开该项目的详情。
- **预期**
  - 项目成员块仍显示当时快照：`兼职`，不会被新设置覆盖。
  - 证明成员快照独立于当前用户状态。

---

### 四、兼职销售分成计算测试

#### 用例 6：项目完成后兼职销售分成生成
- **前置**
  - 使用用例 4 创建的项目；项目金额 100,000，公司应收 20,000，税率 10%，存在兼职销售成员。
- **步骤**
  1. PM 在项目详情页点击 `项目完成`。
  2. 等待系统返回“项目完成，KPI 已生成”提示。
  3. 以财务角色进入 KPI / 报表模块。
  4. 按角色筛选 `part_time_sales`，找到该项目对应记录。
- **预期**
  - 兼职销售记录的 `kpiValue`（或分成金额）：
    - 计算：
      - 成交额 = 100,000
      - 公司应收 = 20,000
      - 税率 = 10% (0.1)
      - 应收金额 = 100,000 - 20,000 = 80,000
      - 税金 = 80,000 × 0.1 = 8,000
      - 返还佣金 = 80,000 - 8,000 = 72,000
    - 预期 `kpiValue = 72,000`。
  - 记录详情中公式字段包含类似：
    - `成交额(100000) - 公司应收(20000) ... 返还佣金(72000)`。

#### 用例 7：兼职销售不生成普通销售 KPI
- **步骤**
  1. 在报表中按角色筛选 `sales`。
- **预期**
  - 对于同一项目，仅出现专职销售的 KPI 记录，不出现该兼职销售的销售 KPI。
  - 确认兼职销售仅出现在 `part_time_sales` 角色下。

---

### 五、兼职排版费用生成测试

#### 用例 8：排版费用占比校验
- **步骤**
  1. 在项目编辑页，将项目金额改为 10,000。
  2. 在“兼职排版”区域输入排版费用：
     - 场景 A：400（占 4%）
     - 场景 B：600（占 6%）
  3. 场景 A 保存，场景 B 保存。
- **预期**
  - 场景 A：保存成功，提示占比为 4%，合法。
  - 场景 B：前端提示“排版费用不能超过项目总金额的5%”，不允许保存。

#### 用例 9：项目完成后生成排版费用记录
- **前置**
  - 采用场景 A（排版费用 400 元）的项目。
- **步骤**
  1. PM 点击“项目完成”。
  2. 财务在 KPI / 报表中按角色 `layout` 筛选该项目记录。
- **预期**
  - 生成一条角色为 `layout` 的记录：
    - `kpiValue = 400`
    - 公式字段类似：`排版费用：400元`。

---

### 六、实时 KPI / 预估分成展示测试

#### 用例 10：项目详情中的实时预估分成
- **步骤**
  1. 打开一个尚未完成但已配置兼职销售和兼职排版的项目。
  2. 滚动到“预估KPI/预估分成”区域，点击“刷新”。
- **预期**
  - 若当前登录角色是 `part_time_sales`：
    - 区块标题应显示“预估分成金额”或类似文案。
    - 结果列表中包含本项目的兼职销售行，金额与用例 6 计算一致（视实现为实时或近似）。
  - 对于其他角色，则显示正常的“预估KPI（分值）”说明。

---

### 七、报表与历史一致性测试

#### 用例 11：历史项目专/兼职不受用户状态更改影响
- **步骤**
  1. 创建多个项目，分别使用同一用户在不同时间以专职、兼职身份参与（通过修改用户 `employmentType` 并重新添加项目成员）。
  2. 完成这些项目，生成 KPI / 分成。
  3. 后续再次修改该用户当前的 `employmentType`。
  4. 重新打开历史项目详情与报表。
- **预期**
  - 历史项目的成员“专/兼职”展示与当时快照一致。
  - 报表中的角色与金额不受当前用户专/兼职变更影响。

---

### 八、回归测试建议

1. **普通销售 / 翻译 / PM KPI 流程**：
   - 确认在不使用兼职的项目中，KPI 生成逻辑不受影响。
2. **用户管理其他功能**：
   - 创建、编辑、删除、重置密码功能正常。
3. **权限控制**：
   - 非管理员无法修改“专/兼职”与角色分配。
4. **导出 / 报表**：
   - 若有导出 Excel 等功能，检查导出结果中角色与金额是否与页面一致。



