# 项目成员接受/拒绝功能更新总结

## 更新日期
2025-12-25

## 更新内容

### 1. 项目成员接受/拒绝功能

#### 功能描述
- 生产人员（翻译、审校、排版、兼职翻译）添加后需要主动接受项目分配
- 管理人员（项目经理、销售等）自动接受，无需确认
- 成员可以接受或拒绝项目分配，并填写拒绝原因

#### 操作流程
1. **项目经理添加成员**：
   - 在项目编辑页面添加生产人员
   - 系统自动设置状态为"待确认"
   - 发送通知给被添加的成员

2. **成员接受/拒绝**：
   - 成员登录后，在项目详情页面可以看到"接受"和"拒绝"按钮
   - 点击"接受"：状态变为"已接受"，项目经理收到通知
   - 点击"拒绝"：状态变为"已拒绝"，填写拒绝原因，项目经理收到通知

3. **项目状态自动流转**：
   - 当所有生产角色都有有效成员且都已接受后，项目状态自动变为"进行中"
   - 如果有成员拒绝，项目保持"待安排"状态，需要重新安排

### 2. 项目状态判断逻辑优化

#### 核心改进
- **按角色分组检查**：系统会检查每个生产角色（翻译、审校、排版、兼职翻译）
- **有效成员判断**：只检查有效的（非拒绝的）成员
- **状态流转规则**：
  - 每个角色如果曾经分配过，必须有有效的（非拒绝的）成员
  - 所有有效成员都必须已接受
  - 只有当所有角色都满足条件时，项目才会变为"进行中"

#### 拒绝处理
- 拒绝的成员记录会保留，但不会影响项目状态判断（如果该角色已有新的有效成员）
- 如果某个角色有拒绝的成员，需要删除并重新安排新成员
- 新成员需要重新确认

### 3. 多角色用户角色筛选功能

#### 功能描述
- 当用户拥有多个项目成员相关角色时，支持按角色筛选项目
- 顶部角色切换时，项目列表自动根据当前角色过滤
- 项目列表提供角色筛选器，可以选择特定角色或"全部角色"

#### 实现细节
- **前端自动过滤**：`loadProjects()` 函数会自动根据当前角色过滤（如果用户有多个角色）
- **后端查询优化**：角色筛选查询会排除拒绝的成员（`acceptanceStatus !== 'rejected'`）
- **角色名称动态读取**：从数据库动态读取角色名称，支持在系统中修改

#### 使用场景
- 用户同时拥有翻译和审校角色
- 作为翻译参与项目A，作为审校参与项目B
- 切换到"翻译"角色时，只显示项目A
- 切换到"审校"角色时，只显示项目B

### 4. 通知功能增强

#### 通知范围
- 成员接受/拒绝时，通知所有项目经理和项目创建者
- 通知包含成员姓名、角色、项目名称和操作结果

#### 通知类型
- `MEMBER_ACCEPTED`：成员已接受
- `MEMBER_REJECTED`：成员已拒绝（包含拒绝原因）

## 技术实现

### 数据模型修改

#### ProjectMember 模型
- 新增 `acceptanceStatus` 字段（enum: ['pending', 'accepted', 'rejected']）
- 新增 `acceptanceAt` 字段（Date，接受/拒绝时间）
- 新增 `rejectionReason` 字段（String，拒绝原因）

#### Project 模型
- 新增 `memberAcceptance` 对象：
  - `requiresConfirmation`：是否需要成员确认
  - `pendingCount`：待确认成员数量
  - `acceptedCount`：已接受成员数量
  - `rejectedCount`：已拒绝成员数量
  - `allConfirmed`：所有成员是否都已确认

### API 接口

#### 接受项目分配
- **POST** `/api/projects/:id/members/:memberId/accept`
- 验证成员是否属于当前用户
- 更新成员状态和项目统计
- 检查项目状态并自动流转
- 发送通知

#### 拒绝项目分配
- **POST** `/api/projects/:id/members/:memberId/reject`
- 验证成员是否属于当前用户
- 更新成员状态和项目统计
- 保持项目状态为"待安排"
- 发送通知

### 前端实现

#### 项目详情页面
- 显示成员接受状态（待确认/已接受/已拒绝）
- 为当前用户的待确认成员显示"接受"和"拒绝"按钮
- 显示接受/拒绝日期和拒绝原因

#### 项目列表页面
- 角色筛选器（仅多角色用户显示）
- 自动根据当前角色过滤项目
- 同步角色筛选器显示值

#### 角色切换
- 顶部角色切换时自动重新加载项目列表
- 项目列表根据当前角色自动过滤

## 数据库迁移

### 迁移脚本
运行 `migrations/add_member_acceptance.js` 为现有数据设置默认值：
- 为所有现有成员设置 `acceptanceStatus = 'accepted'`
- 为所有现有项目初始化 `memberAcceptance` 字段

### 运行方式
```bash
node migrations/add_member_acceptance.js
```

## 测试要点

### 功能测试
1. 添加生产人员后，状态为"待确认"
2. 成员登录后能看到"接受"和"拒绝"按钮
3. 接受/拒绝操作有明确的提示信息
4. 所有成员接受后，项目状态自动变为"进行中"
5. 有成员拒绝时，项目保持"待安排"状态
6. 拒绝后重新安排新成员，新成员接受后项目可以正常进行

### 角色筛选测试
1. 多角色用户切换角色时，项目列表自动过滤
2. 角色筛选器正确显示和过滤
3. 拒绝的成员不显示在项目列表中

### 边界情况测试
1. 多个成员拒绝
2. 拒绝后重新安排所有角色
3. 部分角色有拒绝成员，部分角色正常接受

## 注意事项

1. **必须使用被添加的成员账号登录**才能看到接受/拒绝按钮
2. **历史数据**：现有成员的 `acceptanceStatus` 默认为 `accepted`，不会显示按钮
3. **只有新添加的生产人员**才会显示待确认状态和按钮
4. **管理人员**（PM、销售等）自动接受，不需要确认
5. **项目状态判断**：系统会按角色分组检查，每个角色都需要有有效成员且都已接受
6. **拒绝成员过滤**：拒绝的成员不会显示在项目列表中，但记录会保留

## 相关文档

- `SYSTEM_OPERATION_MANUAL.md` - 系统操作手册（已更新）
- `TESTING_GUIDE.md` - 测试指南（已更新）
- `MEMBER_ACCEPTANCE_TEST_GUIDE.md` - 成员接受测试指南（已更新）
- `PROJECT_MEMBER_ACCEPTANCE_FLOW.md` - 项目成员接受流程文档（已更新）

---

**文档版本：** 1.0  
**最后更新：** 2025-12-25

