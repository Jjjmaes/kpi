# 完成系数逻辑说明

## 概述
完成系数用于调整各岗位的KPI计算，反映项目执行质量（返修、延期、客诉等因素）。

**重要说明**：KPI以"分值（Score）"为单位，表示在团队中的贡献权重，不与工资直接挂钩。

## 完成系数计算规则

### 基础系数
- 默认值：1.0（从项目创建时的配置中获取 `locked_ratios.completion_factor`）

### 影响因素（累积计算，按顺序应用）

1. **返修影响**
   - 每次返修减少5%
   - 计算公式：`factor = factor * (1 - revisionCount * 0.05)`
   - 示例：
     - 1次返修：1.0 * (1 - 1 * 0.05) = 0.95
     - 2次返修：1.0 * (1 - 2 * 0.05) = 0.90
     - 3次返修：1.0 * (1 - 3 * 0.05) = 0.85

2. **延期影响**
   - 延期减少10%
   - 计算公式：`factor = factor * 0.9`
   - 示例：0.95 * 0.9 = 0.855

3. **客诉影响**
   - 客诉减少20%
   - 计算公式：`factor = factor * 0.8`
   - 示例：0.855 * 0.8 = 0.684

### 完整示例

**场景1：正常项目（无返修、无延期、无客诉）**
- 完成系数 = 1.0

**场景2：1次返修**
- 完成系数 = 1.0 * (1 - 1 * 0.05) = 0.95

**场景3：延期**
- 完成系数 = 1.0 * 0.9 = 0.90

**场景4：客诉**
- 完成系数 = 1.0 * 0.8 = 0.80

**场景5：1次返修 + 延期 + 客诉**
- 步骤1：返修 = 1.0 * (1 - 1 * 0.05) = 0.95
- 步骤2：延期 = 0.95 * 0.9 = 0.855
- 步骤3：客诉 = 0.855 * 0.8 = 0.684
- 最终完成系数 = 0.684

**场景6：2次返修 + 延期 + 客诉**
- 步骤1：返修 = 1.0 * (1 - 2 * 0.05) = 0.90
- 步骤2：延期 = 0.90 * 0.9 = 0.81
- 步骤3：客诉 = 0.81 * 0.8 = 0.648
- 最终完成系数 = 0.648

## 各岗位完成系数使用规则

### 1. 销售（sales）
- **完成系数**：根据回款周期计算（0.6-1.0），不受返修/延期/客诉影响
- **业务逻辑**：销售KPI主要考核成交和回款，返修/延期/客诉不直接扣减销售KPI，但回款速度影响完成系数
- **回款周期计算**：从项目完成时间（completedAt）到回款时间（receivedAt）的月数
- **完成系数规则**：
  - 3个月以内：1.0
  - 3-6个月：0.9
  - 6-9个月：0.8
  - 9-12个月：0.7
  - 12个月以上：0.6
- **特殊情况**：
  - 如果项目未完成，使用项目创建时间（createdAt）作为起始时间
  - 如果未回款，完成系数默认为1.0（待回款项目暂不扣减）
- **实现**：使用 `calculateCompletionFactorForSales()` 函数，根据回款周期返回对应系数

### 2. 兼职销售（part_time_sales）
- **完成系数**：不涉及（直接计算佣金）
- **业务逻辑**：佣金 = 成交额 - 公司应收 - 税费，不涉及完成系数

### 3. 兼职排版（layout）
- **完成系数**：不涉及（直接使用排版费用）
- **业务逻辑**：KPI = 排版费用，不涉及完成系数

### 4. 翻译（translator）
- **完成系数**：使用项目完成系数（受返修/延期/客诉影响）
- **计算公式**：`KPI = 项目金额 × 翻译系数 × 字数占比 × 完成系数`
- **业务逻辑**：翻译质量直接影响返修，因此返修会影响翻译KPI

### 5. 审校（reviewer）
- **完成系数**：使用项目完成系数（受返修/延期/客诉影响）
- **计算公式**：`KPI = 项目金额 × 审校系数 × 完成系数`
- **业务逻辑**：审校质量直接影响返修，因此返修会影响审校KPI

### 6. 项目经理（pm）
- **完成系数**：使用项目完成系数（受返修/延期/客诉影响）
- **计算公式**：`KPI = 项目金额 × PM系数 × 完成系数`
- **业务逻辑**：PM负责人员安排和质量管控，返修/延期/客诉反映PM管理质量

### 7. 综合岗（admin_staff）
- **完成系数**：使用管理员评价的完成系数（好1.1、中1.0、差0.8）
- **计算公式**：`KPI = 全公司当月项目总金额 × 综合岗系数 × 完成系数（管理员评价）`
- **业务逻辑**：
  - 不受单个项目的返修/延期/客诉影响
  - 按月汇总计算，由管理员评价本月整体表现
  - 评价等级：好（1.1倍）、中（1.0倍）、差（0.8倍）

### 8. 财务岗（finance）
- **完成系数**：使用管理员评价的完成系数（好1.1、中1.0、差0.8）
- **计算公式**：`KPI = 全公司当月项目总金额 × 财务岗系数 × 完成系数（管理员评价）`
- **业务逻辑**：
  - 不受单个项目的返修/延期/客诉影响
  - 按月汇总计算，由管理员评价本月整体表现
  - 评价等级：好（1.1倍）、中（1.0倍）、差（0.8倍）

## 代码实现位置

### 完成系数计算
- **文件**：`models/Project.js`
- **方法**：`projectSchema.methods.calculateCompletionFactor()`
- **说明**：计算项目的完成系数，考虑返修、延期、客诉

### 销售完成系数
- **文件**：`services/kpiService.js`
- **函数**：`calculateCompletionFactorForSales(project)`
- **说明**：始终返回 1.0，不受项目质量影响

### 综合岗/财务岗完成系数
- **文件**：`models/MonthlyRoleKPI.js`
- **字段**：`evaluationFactor`（管理员评价的完成系数）
- **说明**：由管理员在月度KPI生成后评价

## 注意事项

1. **累积计算**：返修、延期、客诉的影响是累积的（乘法），不是加法
2. **最小值保护**：完成系数不会低于 0
3. **综合岗/财务岗**：不在项目级计算KPI，只在月度汇总时计算
4. **销售特殊处理**：销售完成系数固定为1，但回款奖励部分仍使用完成系数（虽然值为1）

## 潜在问题与建议

### 当前逻辑
- 返修、延期、客诉的影响是累积的，可能导致完成系数过低
- 例如：2次返修 + 延期 + 客诉 = 0.648，意味着KPI减少35.2%

### 建议
1. **确认业务规则**：累积计算是否符合业务预期
2. **上限控制**：考虑设置完成系数下限（如不低于0.5）
3. **返修次数上限**：考虑设置返修影响的上限（如最多减少50%）

