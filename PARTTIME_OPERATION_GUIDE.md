## 兼职专/兼操作说明（销售 / 翻译 / 排版）

本说明基于 `PARTTIME_DEVELOPMENT_GUIDE.md` 对应的实现，面向实际业务操作人员（管理员、销售、PM、财务）。

---

### 一、基础概念

- **专职 / 兼职来源**
  - 在 `用户管理` 中为每个用户设置“专/兼职”（`employmentType`）。
  - 在 `项目成员` 中会冗余一份当时的“专/兼职”快照，用于历史计算与追溯。
- **影响范围**
  - 销售：
    - 专职：走原有销售 KPI（金额奖励 + 回款奖励）。
    - 兼职：走“兼职销售分成”，不再走销售 KPI。
  - 排版：
    - 专职：可参与 KPI（如后续规则扩展）。
    - 兼职：按项目录入的“排版费用”生成记录，不走专职 KPI。
  - 翻译：
    - 当前逻辑保持原翻译 KPI，如后续启用兼职翻译费用，可参照兼职排版流程。

---

### 二、管理员：设置用户专职 / 兼职

1. **进入用户管理**
   - 登录系统，使用管理员账号。
   - 左侧导航选择 `用户管理`。

2. **创建新用户时设置**
   - 点击 `创建用户` 按钮。
   - 填写：用户名、密码、姓名、邮箱、电话等。
   - 在 **“专/兼职”** 下拉框中选择：
     - `专职`（full_time）
     - `兼职`（part_time）
   - 在 **“角色”** 区域勾选对应的系统角色（如 `sales`, `part_time_sales`, `layout` 等）。
   - 点击 `创建` 提交。

3. **编辑既有用户时调整**
   - 在用户列表中，点击对应行的 `编辑`。
   - 可修改：邮箱、电话、角色、启用状态、**专/兼职**。
   - 在 **“专/兼职”** 下拉框中选择需要的值后，点击 `更新`。

4. **列表查看用户专/兼职**
   - 用户列表表格包含列：
     - 姓名、用户名、邮箱、电话、角色、**专/兼职**、状态、操作。
   - “专/兼职”列显示：
     - `专职`：表示 full_time。
     - `兼职`：表示 part_time。

> 建议：管理员统一维护兼职销售 / 兼职排版人员的 `employmentType`，避免项目中混淆。

---

### 三、PM / 销售：在项目中使用兼职销售

#### 1. 项目创建与兼职销售信息

1. 由销售或具备权限的用户进入 `项目管理` → `创建项目`。
2. 在项目表单中填写基础信息（项目名称、客户、金额等）。
3. 根据现有业务逻辑，在项目中填写：
   - **启用兼职销售** 相关字段（若有单独区域）：
     - 公司应收金额
     - 税率
   - 填写完成后，系统会根据：
     - `成交额（项目总金额）`
     - `公司应收`
     - `税率`
   - 在后台根据公式计算返还佣金：
     \[
     返还佣金 = (成交额 - 公司应收) - (成交额 - 公司应收) \times 税率
     \]

> 注意：兼职销售本身仍然需要在“项目成员”中添加，系统才会生成相应记录。

#### 2. 添加兼职销售为项目成员

1. 在项目创建窗体底部的 **“项目成员”** 区域：
   - 角色选择下拉框选择 `兼职销售`（通常为 `part_time_sales`）。
   - 用户下拉框中自动过滤出具备该角色的用户，并显示其“专/兼职”标记，例如：
     - `张三 (zhangsan) - 兼职`
2. 点击 `+ 添加成员`，成员将出现在下方“已添加成员”列表。
3. 列表中每个成员条目会显示：
   - **姓名 - 角色 （专/兼职）**，例如：`张三 - 兼职销售 (兼职)`。

#### 3. 项目完成后的分成生成

1. PM 在项目详情页点击 `项目完成`。
2. 系统会：
   - 校验项目状态和必要信息（金额、成员、质量信息等）。
   - 调用 KPI 生成服务，为每个成员计算相应记录。
3. 对于 **兼职销售**：
   - 若成员的 **项目成员快照 employmentType = part_time**：
     - 使用“兼职销售分成公式”计算：
       \[
       返还佣金 = (成交额 - 公司应收) - (成交额 - 公司应收) \times 税率
       \]
     - 以角色 `part_time_sales` 生成 KPI / 分成记录。
   - 若误设为专职，则会走普通销售 KPI，请管理员及时纠正。

4. 在 `KPI / 分成报表` 中，财务可查看该兼职销售对应的记录和公式说明。

---

### 四、PM：在项目中使用兼职排版

#### 1. 在项目中录入排版信息

1. 进入项目的创建或编辑页面。
2. 在 **“兼职排版”**（或相应）区域：
   - 启用兼职排版选项。
   - 输入 **排版费用**。
   - 选择排版员（从用户列表中选择，列表会标记其“专/兼职”）。
3. 系统会自动校验：
   - 排版费用是否超过项目总金额的 5%：
     - 若超过，界面提示错误，不允许保存。

#### 2. 添加兼职排版为项目成员

1. 在 `项目成员` 区域：
   - 角色选择 `兼职排版`（`layout`）。
   - 用户下拉框过滤出拥有 `layout` 角色的用户，并显示其“专/兼职”标签。
2. 点击 `+ 添加成员`。
3. “已添加成员”列表中显示：
   - `李四 - 兼职排版 (兼职) (费用: ¥400.00)` 这类信息。

#### 3. 项目完成后的排版费用记录

1. PM 点击 `项目完成`。
2. 系统会：
   - 检查项目 `partTimeLayout.layoutCost` 等字段。
   - 为排版成员生成记录（角色 `layout`，KPI/费用值 = 录入的排版费用）。
3. 财务可在 KPI / 费用相关报表中查看排版费用记录，查看：
   - 项目名称、排版员、金额、公式说明（例如：`排版费用：400元`）。

---

### 五、项目成员视图中的专/兼职标识

1. 进入项目详情页。
2. 在 `项目成员` 区块：
   - 每行成员展示：
     - **姓名 - 角色 （专/兼职）**，例如：
       - `张三 - 销售 (专职)`
       - `王五 - 兼职销售 (兼职)`
       - `李四 - 兼职排版 (兼职) (排版费用: ¥400.00)`
3. 该标识基于当时成员快照的 `employmentType`，即使之后用户在“用户管理”中的专/兼职被改动，历史项目的显示仍保持当时状态，保障历史准确性。

---

### 六、财务：查看兼职相关 KPI / 分成 / 费用

1. 进入 KPI / 报表模块。
2. 通过以下方式查看：
   - 按角色筛选 `part_time_sales`，可查看所有兼职销售分成记录。
   - 按角色筛选 `layout`，可查看所有兼职排版的费用/KPI 记录。
3. 查看单条记录的“计算详情”/“公式说明”时，可看到：
   - 兼职销售：
     - 成交额、公司应收、税率、返还佣金计算过程。
   - 兼职排版：
     - 项目金额、排版费用、占比校验说明（部分在项目界面）。

---

### 七、常见问题与排查建议

1. **项目中看不到用户的“专/兼职”标记？**
   - 检查“用户管理”中该用户是否已设置 `employmentType`。
   - 检查项目成员是否在新规则发布后添加，如果是旧数据可能缺少快照，需管理员补录。

2. **兼职销售却生成了普通销售 KPI？**
   - 检查：
     - 该用户在“用户管理”中的 `employmentType` 是否为 `part_time`。
     - 在该项目中添加成员时是否选择了正确角色（`part_time_sales`）。

3. **排版费用校验失败或提示超过 5%？**
   - 核对项目总金额填写是否正确。
   - 重新计算：`排版费用 / 项目总金额` 是否 > 5%。

4. **报表中看不到兼职记录？**
   - 确认项目是否已点击“项目完成”并成功生成 KPI。
   - 使用按角色筛选 `part_time_sales`、`layout` 再试。



