# 角色切换系统实现文档

## 概述

已完整实现"一用户多角色"的角色切换系统。用户登录后可以选择当前使用的角色，系统会根据当前角色动态调整界面和权限。

## 核心功能

### 1. 角色切换器
- 位置：主界面顶部，用户名旁边
- 功能：下拉选择当前角色
- 显示：只有当用户拥有多个角色时才显示

### 2. 权限控制
- **前端**：基于当前角色动态显示/隐藏菜单项和功能按钮
- **后端**：基于当前角色进行数据过滤和权限验证
- **API请求**：自动在请求头中携带 `X-Role` 标识当前角色

### 3. 数据过滤
- **项目列表**：根据当前角色权限过滤可见项目
  - `all`: 查看所有项目（管理员、财务、PM、综合岗）
  - `sales`: 只看自己创建的项目（销售、兼职销售）
  - `assigned`: 只看分配给我的项目（翻译、审校、排版）
- **客户信息**：翻译/审校/排版角色自动脱敏客户信息
- **金额信息**：翻译/审校/排版角色不显示项目金额

## 权限表

### 角色权限说明

| 角色 | 项目查看 | 项目编辑 | KPI查看 | 财务查看 | 客户管理 | 用户管理 | 系统配置 |
|------|---------|---------|---------|---------|---------|---------|---------|
| 管理员 | 全部 | ✅ | 全部 | ✅ | ✅ | ✅ | ✅ |
| 财务 | 全部 | ❌ | 全部 | ✅ | ✅ | ❌ | ❌ |
| 项目经理 | 全部 | ✅ | 全部 | ❌ | ✅ | ❌ | ❌ |
| 销售 | 自己的 | ✅ | 自己的 | 自己的 | ✅ | ❌ | ❌ |
| 兼职销售 | 自己的 | ✅ | 自己的 | 自己的 | ✅ | ❌ | ❌ |
| 翻译 | 分配的 | ❌ | 自己的 | ❌ | ❌ | ❌ | ❌ |
| 审校 | 分配的 | ❌ | 自己的 | ❌ | ❌ | ❌ | ❌ |
| 排版 | 分配的 | ❌ | 自己的 | ❌ | ❌ | ❌ | ❌ |
| 综合岗 | 全部 | ✅ | 全部 | ❌ | ✅ | ❌ | ❌ |

## 技术实现

### 后端

1. **权限配置** (`config/permissions.js`)
   - 定义每个角色的权限表
   - 角色优先级（用于默认角色选择）
   - 角色显示名称

2. **认证中间件** (`middleware/auth.js`)
   - `authenticate`: 验证JWT并解析当前角色（从 `X-Role` header）
   - `authorize`: 基于当前角色进行权限检查
   - `requirePermission`: 基于权限表检查权限
   - `getCurrentPermission`: 获取当前角色的权限值

3. **路由修改**
   - 项目列表路由：基于当前角色过滤数据
   - 其他路由：逐步迁移到基于角色的权限检查

### 前端

1. **角色管理**
   - `currentRole`: 当前选择的角色（localStorage持久化）
   - `roleNames`: 角色显示名称映射
   - `switchRole()`: 切换角色函数

2. **API请求包装**
   - `apiFetch()`: 自动添加 `Authorization` 和 `X-Role` header
   - 所有API调用已替换为 `apiFetch`

3. **UI动态更新**
   - `initRoleSwitcher()`: 初始化角色切换器
   - `refreshMenu()`: 根据当前角色刷新菜单显示
   - `hasPermission()`: 检查当前角色是否有权限
   - `getPermission()`: 获取当前角色的权限值

4. **权限判断函数**
   - `isFinanceRole()`: 基于当前角色判断是否为财务角色
   - `isSalesRole()`: 基于当前角色判断是否为销售角色
   - `canViewProjectAmount()`: 基于当前角色判断是否可查看金额

## 使用说明

### 用户操作

1. **登录**
   - 系统自动选择默认角色（优先级最高的角色）
   - 如果用户有多个角色，顶部显示角色切换器

2. **切换角色**
   - 点击顶部角色下拉框
   - 选择要切换的角色
   - 系统自动刷新界面和数据

3. **角色记忆**
   - 选择的角色会保存到 localStorage
   - 下次登录时自动恢复上次选择的角色

### 开发者说明

1. **添加新权限**
   - 在 `config/permissions.js` 的 `PERMISSIONS` 对象中添加
   - 在前端 `PERMISSIONS` 对象中同步添加

2. **修改权限检查**
   - 使用 `requirePermission('permission.name')` 中间件
   - 使用 `getCurrentPermission(req, 'permission.name')` 获取权限值

3. **数据过滤**
   - 在路由中使用 `req.currentRole` 获取当前角色
   - 使用 `getCurrentPermission()` 获取权限值进行过滤

## 向后兼容

- 如果请求未携带 `X-Role` header，系统使用旧逻辑（所有角色权限叠加）
- 逐步迁移到新逻辑，不影响现有功能

## 安全措施

1. **角色验证**：后端验证用户确实拥有请求的角色
2. **权限检查**：每个API都进行权限验证
3. **数据隔离**：基于角色进行行级数据过滤

## 测试建议

1. **多角色用户登录**：验证角色切换器显示
2. **角色切换**：验证界面和数据刷新
3. **权限验证**：验证不同角色看到不同的菜单和数据
4. **数据过滤**：验证翻译/审校只能看到分配的项目
5. **客户信息脱敏**：验证翻译/审校/排版看不到客户详细信息

## 后续优化

1. 完善其他路由的基于角色的数据过滤（KPI、财务等）
2. 添加角色切换的审计日志
3. 优化角色切换时的加载体验
4. 添加角色权限的图形化配置界面






















