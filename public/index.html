<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语家 OA 系统</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // 异步加载 Chart.js，使用多个备用 CDN 源
        (function() {
            const cdnSources = [
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js',
                'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.min.js',
                'https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.0/chart.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js'
            ];
            
            let currentIndex = 0;
            
            function tryLoadChart() {
                if (currentIndex >= cdnSources.length) {
                    console.warn('所有 Chart.js CDN 源都加载失败，图表功能不可用');
                    window.Chart = null;
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdnSources[currentIndex];
                script.async = true;
                
                script.onload = function() {
                    console.log('Chart.js 加载成功，来源:', cdnSources[currentIndex]);
                };
                
                script.onerror = function() {
                    console.warn('Chart.js CDN 源加载失败，尝试下一个:', cdnSources[currentIndex]);
                    currentIndex++;
                    tryLoadChart();
                };
                
                document.head.appendChild(script);
            }
            
            tryLoadChart();
        })();
    </script>
    <script src="js/utils/security.js"></script>
</head>
<body>
    <!-- 登录页面 -->
    <div id="loginSection" class="container">
        <div class="login-form section active">
            <h2 id="loginTitle">语家 OA 系统</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit">登录</button>
            </form>
            <div id="loginAlert"></div>
        </div>
    </div>

    <!-- 主应用 -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <header>
                <h1 id="mainTitle">语家 OA 办公自动化系统</h1>
                <div class="user-info">
                    <div class="user-meta">
                        <span id="userName"></span>
                        <span id="currentRoleTag" class="role-tag" style="display:none;"></span>
                    </div>
                    <div class="user-actions">
                        <span id="roleSwitcherContainer" style="display: none;"></span>
                        <button id="profileHeaderBtn" class="profile-btn" data-click="showSection('profile')" style="display:none;" title="个人中心">
                            <span style="margin-right: 4px;">👤</span>个人中心
                        </button>
                        <div id="notificationArea" class="notification-area" style="display:none;">
                            <button id="notificationBtn" class="notification-btn" data-click="toggleNotificationPanel()">
                                通知
                                <span id="notificationBadge" class="notification-badge" style="display:none;"></span>
                            </button>
                            <div id="notificationPanel" class="notification-panel" style="display:none;">
                                <div class="notification-panel-header">
                                    <span>通知</span>
                                    <button class="btn-small" data-click="markAllNotificationsRead()">全部已读</button>
                                </div>
                                <div id="notificationList" class="notification-list"></div>
                            </div>
                        </div>
                        <button class="logout-btn" data-click="logout()">退出</button>
                    </div>
                </div>
            </header>

            <nav class="nav">
                <button data-click="showSection('dashboard')" class="active">业务看板</button>
                <button data-click="showSection('projects')">项目管理</button>
                <button data-click="showSection('customers')" id="customersBtn" style="display:none;">客户管理</button>
                <button data-click="showSection('kpi')">KPI查询</button>
                <button data-click="showSection('express')">快递管理
                    <span id="expressNavBadge" class="nav-badge" style="display:none;">0</span>
                </button>
                <button data-click="showSection('officeSupply')" id="officeSupplyBtn" style="display:none;">办公用品采购
                    <span id="officeSupplyNavBadge" class="nav-badge" style="display:none;">0</span>
                </button>
                <button data-click="showSection('seal')">章证使用
                    <span id="sealNavBadge" class="nav-badge" style="display:none;">0</span>
                </button>
                <button data-click="showSection('expense')">报销管理
                    <span id="expenseNavBadge" class="nav-badge" style="display:none;">0</span>
                </button>
                <button data-click="showSection('finance')" id="financeBtn" style="display:none;">财务管理</button>
                <button data-click="showSection('config')" id="configBtn" style="display:none;">KPI配置</button>
                <button data-click="showSection('users')" id="usersBtn" style="display:none;">用户管理</button>
                <button data-click="showSection('languages')" id="languagesBtn" style="display:none;">语种管理</button>
                <button data-click="showSection('permissions')" id="permissionsBtn" style="display:none;">权限配置</button>
                <button data-click="showSection('backup')" id="backupBtn" style="display:none;">数据备份</button>
                <button data-click="showSection('help')" style="margin-left: auto;">帮助文档</button>
            </nav>

            <!-- 业务看板 -->
            <div id="dashboard" class="section active">
                <div id="dashboardTodayInfo" style="margin-bottom: 20px;"></div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <label style="white-space: nowrap; font-size: 14px;">选择月份：</label>
                        <select id="dashboardYear" data-change="updateDashboardMonth()" style="padding: 6px; min-width: 100px;"></select>
                        <select id="dashboardMonthSelect" data-change="updateDashboardMonth()" style="padding: 6px; min-width: 100px;"></select>
                        <input type="hidden" id="dashboardMonth" value="">
                    </div>
                    <select id="dashboardStatus" style="padding: 6px;" data-change="loadDashboard()">
                        <option value="">全部状态</option>
                        <option value="pending">待开始</option>
                        <option value="in_progress">进行中</option>
                        <option value="completed">已完成</option>
                        <option value="cancelled">已取消</option>
                    </select>
                    <select id="dashboardBusinessType" style="padding: 6px;" data-change="loadDashboard()">
                        <option value="">全部业务</option>
                        <option value="translation">笔译</option>
                        <option value="interpretation">口译</option>
                        <option value="transcription">转录</option>
                        <option value="localization">本地化</option>
                        <option value="other">其他</option>
                    </select>
                    <select id="dashboardRole" style="padding: 6px;" data-change="loadDashboard()">
                        <option value="">全部角色</option>
                        <option value="sales">销售</option>
                        <option value="pm">项目经理</option>
                        <option value="translator">翻译</option>
                        <option value="reviewer">审校</option>
                        <option value="admin_staff">综合岗</option>
                    </select>
                    <button data-click="loadDashboard()" style="padding: 6px 12px;">刷新</button>
                </div>
                <div id="dashboardCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px;"></div>
                <div id="dashboardCharts" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;"></div>
            </div>

            <!-- 回款完成率详情（独立页面，不依赖财务导航） -->
            <div id="paymentDetail" class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
                    <div>
                        <h2 style="margin:0;">回款完成率详情</h2>
                        <p style="margin:4px 0 0;color:#666;">查看可见范围内项目的回款进度</p>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn-secondary" data-click="showSection('dashboard')">返回看板</button>
                        <button data-click="loadPaymentCompletionDetail()" style="padding:6px 12px;">刷新</button>
                    </div>
                </div>
                <div class="card" style="margin-bottom:16px;">
                    <div class="card-title">筛选</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="month" id="pcdMonth" style="padding:6px; min-width:150px;" data-change="loadPaymentCompletionDetail()">
                        <input type="date" id="pcdStartDate" style="padding:6px; min-width:150px;" placeholder="开始日期" data-change="loadPaymentCompletionDetail()">
                        <input type="date" id="pcdEndDate" style="padding:6px; min-width:150px;" placeholder="结束日期" data-change="loadPaymentCompletionDetail()">
                        <select id="pcdStatus" style="padding:6px;" data-change="loadPaymentCompletionDetail()">
                            <option value="">全部状态</option>
                            <option value="pending">待开始</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="pcdPaymentStatus" style="padding:6px;" data-change="loadPaymentCompletionDetail()">
                            <option value="">全部回款状态</option>
                            <option value="unpaid">未支付</option>
                            <option value="partially_paid">部分支付</option>
                            <option value="paid">已支付</option>
                        </select>
                        <select id="pcdPageSize" style="padding:6px;" data-change="renderPaymentCompletionDetail()">
                            <option value="10">每页10</option>
                            <option value="20">每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button class="btn-secondary" data-click="pcdToggleOverdue()">仅看逾期</button>
                    </div>
                    <div id="paymentCompletionList"></div>
                </div>
            </div>

            <!-- 财务管理 -->
            <div id="finance" class="section">
                <h2>财务管理</h2>
                
                <!-- 财务管理导航卡片 -->
                <div id="financeNavCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="finance-nav-card" data-click="showFinanceSection('receivables')" data-section="receivables">
                        <div class="finance-nav-icon">💰</div>
                        <div class="finance-nav-title">应收对账</div>
                        <div class="finance-nav-desc">查看项目应收款项</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('paymentRecords')" data-section="paymentRecords">
                        <div class="finance-nav-icon">📋</div>
                        <div class="finance-nav-title">回款记录</div>
                        <div class="finance-nav-desc">查看项目回款记录</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('addPayment')" data-section="addPayment">
                        <div class="finance-nav-icon">➕</div>
                        <div class="finance-nav-title">新增回款</div>
                        <div class="finance-nav-desc">录入新的回款记录</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('invoices')" data-section="invoices">
                        <div class="finance-nav-icon">📄</div>
                        <div class="finance-nav-title">发票管理</div>
                        <div class="finance-nav-desc">查看项目发票信息</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('addInvoice')" data-section="addInvoice">
                        <div class="finance-nav-icon">➕</div>
                        <div class="finance-nav-title">新增发票</div>
                        <div class="finance-nav-desc">录入新的发票信息</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('invoiceRequests')" data-section="invoiceRequests" id="invoiceRequestsNavCard" style="display:none;">
                        <div class="finance-nav-icon">📝</div>
                        <div class="finance-nav-title">发票申请审批</div>
                        <div class="finance-nav-desc">审批销售提交的发票申请</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('myInvoiceRequests')" data-section="myInvoiceRequests" id="myInvoiceRequestsNavCard" style="display:none;">
                        <div class="finance-nav-icon">📋</div>
                        <div class="finance-nav-title">我的发票申请</div>
                        <div class="finance-nav-desc">查看我提交的发票申请</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('reconciliation')" data-section="reconciliation">
                        <div class="finance-nav-icon">🔍</div>
                        <div class="finance-nav-title">回款与发票对账</div>
                        <div class="finance-nav-desc">对账报表查询</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('pendingKpi')" data-section="pendingKpi">
                        <div class="finance-nav-icon">⏳</div>
                        <div class="finance-nav-title">KPI审核待办</div>
                        <div class="finance-nav-desc">待审核的KPI记录</div>
                    </div>
                    <div class="finance-nav-card" data-click="showFinanceSection('summary')" data-section="summary">
                        <div class="finance-nav-icon">📊</div>
                        <div class="finance-nav-title">财务汇总</div>
                        <div class="finance-nav-desc">财务数据汇总统计</div>
                    </div>
                </div>
                
                <!-- 应收对账 -->
                <div id="financeSection-receivables" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">应收对账</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="month" id="financeMonth" style="padding:6px; min-width:150px; cursor:pointer;" title="选择月份" data-change="loadReceivables()">
                        <input type="date" id="financeStartDate" style="padding:6px; min-width:150px; cursor:pointer;" title="起始日期" data-change="loadReceivables()">
                        <input type="date" id="financeEndDate" style="padding:6px; min-width:150px; cursor:pointer;" title="结束日期" data-change="loadReceivables()">
                        <select id="financeStatus" style="padding:6px;" data-change="loadReceivables()">
                            <option value="">全部状态</option>
                            <option value="pending">待开始</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="financePaymentStatus" style="padding:6px;" data-change="loadReceivables()">
                            <option value="">全部回款状态</option>
                            <option value="unpaid">未支付</option>
                            <option value="partially_paid">部分支付</option>
                            <option value="paid">已支付</option>
                        </select>
                        <select id="financeHasInvoice" style="padding:6px;" data-change="loadReceivables()">
                            <option value="">全部发票状态</option>
                            <option value="true">已开票</option>
                            <option value="false">未开票</option>
                        </select>
                        <select id="financeCustomer" style="padding:6px; min-width:160px;" data-change="loadReceivables()">
                            <option value="">全部客户</option>
                        </select>
                        <select id="financeSales" style="padding:6px; min-width:160px;" data-change="loadReceivables()">
                            <option value="">全部销售</option>
                        </select>
                        <select id="financePageSize" style="padding:6px;" data-change="renderReceivables()">
                            <option value="10">每页10</option>
                            <option value="20">每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button data-click="exportReceivables()" class="btn-small">导出当前筛选</button>
                        <button data-click="loadReceivables()" style="padding:6px 12px;">刷新</button>
                    </div>
                    <div id="receivablesList"></div>
                    </div>
                </div>

                <!-- 回款记录 -->
                <div id="financeSection-paymentRecords" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">
                            <span id="paymentCardTitle">回款记录</span>
                            <span id="paymentFilterNotice" style="display:none;font-size:12px;color:#666;font-weight:400;margin-left:8px;">仅显示我创建的项目回款</span>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                            <input type="month" id="paymentMonth" style="padding:6px; min-width:150px; cursor:pointer;" title="选择月份" data-change="loadPaymentRecordsProjects()">
                            <input type="date" id="paymentStartDate" style="padding:6px; min-width:150px; cursor:pointer;" title="起始日期" data-change="loadPaymentRecordsProjects()">
                            <input type="date" id="paymentEndDate" style="padding:6px; min-width:150px; cursor:pointer;" title="结束日期" data-change="loadPaymentRecordsProjects()">
                            <select id="paymentStatusFilter" style="padding:6px;" data-change="loadPaymentRecordsProjects()">
                                <option value="">全部状态</option>
                                <option value="pending">待开始</option>
                                <option value="in_progress">进行中</option>
                                <option value="completed">已完成</option>
                                <option value="cancelled">已取消</option>
                            </select>
                            <select id="paymentProjectPaymentStatus" style="padding:6px;" data-change="loadPaymentRecordsProjects()">
                                <option value="">全部回款状态</option>
                                <option value="unpaid">未支付</option>
                                <option value="partially_paid">部分支付</option>
                                <option value="paid">已支付</option>
                            </select>
                            <select id="paymentCustomer" style="padding:6px; min-width:160px;" data-change="loadPaymentRecordsProjects()">
                                <option value="">全部客户</option>
                            </select>
                            <select id="paymentSales" style="padding:6px; min-width:160px;" data-change="loadPaymentRecordsProjects()">
                                <option value="">全部销售</option>
                            </select>
                            <select id="paymentPageSize" style="padding:6px;" data-change="renderPaymentRecordsProjects()">
                                <option value="10">每页10</option>
                                <option value="20">每页20</option>
                                <option value="50">每页50</option>
                            </select>
                            <button data-click="loadPaymentRecordsProjects()" style="padding:6px 12px;">刷新</button>
                        </div>
                        <div id="paymentProjectsList"></div>
                    </div>
                </div>
                
                <!-- 新增回款 -->
                <div id="financeSection-addPayment" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">新增回款</div>
                        <div style="background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:8px 10px;border-radius:6px;font-size:12px;margin:8px 0 4px;">
                            仅非取消项目可录入；回款金额会影响销售回款系数，请确认金额和日期。
                        </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:flex-end;">
                        <div style="position: relative; min-width: 280px; max-width: 320px; flex: 1;">
                            <input type="text" id="paymentProjectSearch" placeholder="搜索项目（编号/名称/客户）" 
                                   style="padding:6px; width:100%;" 
                                   data-focus="showProjectSelector('payment')"
                                   readonly>
                            <input type="hidden" id="paymentProjectId">
                            <div id="paymentProjectInfo" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
                        </div>
                        <input type="number" id="paymentAmount" placeholder="回款金额" step="0.01" min="0" style="padding:6px; width:140px;">
                        <input type="date" id="paymentDate" style="padding:6px; width:160px;">
                        <select id="paymentMethod" style="padding:6px; width:140px;" data-change="handlePaymentMethodChange('global')">
                            <option value="bank">银行转账</option>
                            <option value="cash">现金</option>
                            <option value="alipay">支付宝</option>
                            <option value="wechat">微信</option>
                            <option value="other">其他</option>
                        </select>
                        <div id="paymentReceiverWrap_global" style="display:none; width:160px; min-width:140px;">
                            <select id="paymentReceivedBy" style="padding:6px; width:100%;">
                                <option value="">请选择收款人（财务/销售/兼职销售/管理员）</option>
                            </select>
                        </div>
                        <input type="text" id="paymentReference" placeholder="凭证号/备注" style="padding:6px; width:160px;">
                        <input type="text" id="paymentInvoiceNumber" placeholder="关联发票号（可选）" style="padding:6px; width:160px;">
                        <button data-click="addPaymentRecord()" style="padding:6px 12px;">新增回款</button>
                    </div>
                    <div id="paymentRecords"></div>
                    </div>
                </div>

                <!-- 发票管理 -->
                <div id="financeSection-invoices" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">发票管理</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="month" id="invoiceMonth" style="padding:6px;" data-change="loadInvoiceProjects()">
                        <select id="invoiceStatusFilter" style="padding:6px;" data-change="loadInvoiceProjects()">
                            <option value="">全部状态</option>
                            <option value="pending">待开</option>
                            <option value="issued">已开</option>
                            <option value="paid">已支付</option>
                            <option value="void">作废</option>
                        </select>
                        <select id="invoiceTypeFilter" style="padding:6px;" data-change="loadInvoiceProjects()">
                            <option value="">全部类型</option>
                            <option value="vat">增值税发票</option>
                            <option value="normal">普通发票</option>
                            <option value="other">其他</option>
                        </select>
                        <select id="invoiceCustomer" style="padding:6px; min-width:160px;" data-change="loadInvoiceProjects()">
                            <option value="">全部客户</option>
                        </select>
                        <select id="invoiceSales" style="padding:6px; min-width:160px;" data-change="loadInvoiceProjects()">
                            <option value="">全部销售</option>
                        </select>
                        <select id="invoicePageSize" style="padding:6px;" data-change="renderInvoiceProjects()">
                            <option value="10">每页10</option>
                            <option value="20">每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button data-click="loadInvoiceProjects()" style="padding:6px 12px;">刷新</button>
                    </div>
                    <div id="invoiceProjectsList"></div>
                    </div>
                </div>
                
                <!-- 新增发票 -->
                <div id="financeSection-addInvoice" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">新增发票</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <div style="position: relative; min-width: 300px;">
                            <input type="text" id="invoiceProjectSearch" placeholder="搜索项目（编号/名称/客户）" 
                                   style="padding:6px; width:100%;" 
                                   data-focus="showProjectSelector('invoice')"
                                   readonly>
                            <input type="hidden" id="invoiceProjectId">
                            <div id="invoiceProjectInfo" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
                        </div>
                        <input type="text" id="invoiceNumber" placeholder="发票号" style="padding:6px;min-width:120px;">
                        <input type="number" id="invoiceAmount" placeholder="金额" step="0.01" min="0" style="padding:6px; width:120px;">
                        <input type="date" id="invoiceDate" style="padding:6px;">
                        <select id="invoiceType" style="padding:6px;">
                            <option value="vat">增值税发票</option>
                            <option value="normal">普通发票</option>
                            <option value="other">其他</option>
                        </select>
                        <input type="text" id="invoiceNote" placeholder="备注" style="padding:6px; width:150px;">
                        <button data-click="addInvoice()" style="padding:6px 12px;">新增发票</button>
                    </div>
                    </div>
                </div>
                
                <!-- 发票申请审批（财务侧） -->
                <div id="financeSection-invoiceRequests" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">发票申请审批</div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                            <select id="invoiceRequestStatusFilter" style="padding:6px;" data-change="loadInvoiceRequests()">
                                <option value="">全部状态</option>
                                <option value="pending">待审批</option>
                                <option value="approved">已批准</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                            <select id="invoiceRequestCreatedByFilter" style="padding:6px; min-width:160px;" data-change="loadInvoiceRequests()">
                                <option value="">全部申请人</option>
                            </select>
                            <select id="invoiceRequestCustomerFilter" style="padding:6px; min-width:160px;" data-change="loadInvoiceRequests()">
                                <option value="">全部客户</option>
                            </select>
                            <select id="invoiceRequestPageSize" style="padding:6px;" data-change="renderInvoiceRequests()">
                                <option value="10">每页10</option>
                                <option value="20">每页20</option>
                                <option value="50">每页50</option>
                            </select>
                            <button data-click="loadInvoiceRequests()" style="padding:6px 12px;">刷新</button>
                        </div>
                        <div id="invoiceRequestsList"></div>
                    </div>
                </div>
                
                <!-- 我的发票申请（销售侧） -->
                <div id="financeSection-myInvoiceRequests" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">我的发票申请</div>
                        <div style="background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:8px 10px;border-radius:6px;font-size:12px;margin:8px 0 4px;">
                            仅非取消项目可申请开票；回款金额会影响销售回款系数，请先确认回款记录。
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center;">
                            <button data-click="showCreateInvoiceRequestModal()" style="padding:6px 12px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer;">➕ 申请开票</button>
                            <select id="myInvoiceRequestStatusFilter" style="padding:6px;" data-change="loadMyInvoiceRequests()">
                                <option value="">全部状态</option>
                                <option value="pending">待审批</option>
                                <option value="approved">已批准</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                            <select id="myInvoiceRequestPageSize" style="padding:6px;" data-change="renderMyInvoiceRequests()">
                                <option value="10">每页10</option>
                                <option value="20">每页20</option>
                                <option value="50">每页50</option>
                            </select>
                            <button data-click="loadMyInvoiceRequests()" style="padding:6px 12px;">刷新</button>
                        </div>
                        <div id="myInvoiceRequestsList"></div>
                    </div>
                </div>
                
                <!-- 回款与发票对账 -->
                <div id="financeSection-reconciliation" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">回款与发票对账</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="date" id="reconciliationStartDate" style="padding:6px;" placeholder="开始日期">
                        <input type="date" id="reconciliationEndDate" style="padding:6px;" placeholder="结束日期">
                        <button data-click="loadReconciliation()" style="padding:6px 12px;">查询对账</button>
                        <button data-click="exportReconciliation()" style="padding:6px 12px;">导出对账表</button>
                    </div>
                    <div id="reconciliationList"></div>
                    </div>
                </div>

                <!-- KPI审核待办 -->
                <div id="financeSection-pendingKpi" class="finance-section-content" style="display: none;">
                    <div class="card" style="margin-bottom:16px;">
                        <div class="card-title">KPI审核待办</div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                            <input type="month" id="kpiPendingMonth" style="padding:6px;" data-change="loadPendingKpi()">
                            <button data-click="loadPendingKpi()" style="padding:6px 12px;">刷新</button>
                        </div>
                        <div id="pendingKpiList"></div>
                    </div>
                </div>

                <!-- 财务汇总 -->
                <div id="financeSection-summary" class="finance-section-content" style="display: none;">
                    <div class="card">
                        <div class="card-title">财务汇总报表</div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center;">
                            <label style="display:flex;align-items:center;gap:5px;">
                                <span>年份：</span>
                                <select id="reportYear" data-change="updateReportMonth()" style="padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px;"></select>
                            </label>
                            <label style="display:flex;align-items:center;gap:5px;">
                                <span>月份：</span>
                                <select id="reportMonthSelect" data-change="updateReportMonth()" style="padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px;"></select>
                            </label>
                            <input type="hidden" id="reportMonth">
                            <button data-click="loadFinanceSummary()" style="padding:6px 12px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer;">刷新</button>
                            <button data-click="exportFinanceSummary()" style="padding:6px 12px;background:#10b981;color:white;border:none;border-radius:4px;cursor:pointer;">导出Excel</button>
                        </div>
                        <div id="financeSummary"></div>
                    </div>
                </div>
            </div>

            <!-- 项目管理 -->
            <div id="projects" class="section">
                <div class="projects-header-row">
                    <div class="projects-header">
                        <h2 class="projects-title">项目管理</h2>
                        <p class="projects-subtitle">筛选项目并快捷导出</p>
                    </div>
                    <div class="projects-actions">
                        <button class="btn-secondary" data-click="exportProjects()">导出当前筛选</button>
                        <button data-click="showCreateProjectModal()" id="createProjectBtn" style="display:none;">创建新项目</button>
                    </div>
                </div>
                <div class="projects-filters">
                    <input type="text" id="projectSearch" placeholder="项目名/编号/客户" data-keyup="renderProjects()">
                    <select id="projectStatusFilter" data-change="renderProjects()">
                        <option value="">全部状态</option>
                        <option value="pending">待开始</option>
                        <option value="in_progress">进行中</option>
                        <option value="completed">已完成</option>
                        <option value="cancelled">已取消</option>
                    </select>
                    <select id="projectBizFilter" data-change="renderProjects()">
                        <option value="">全部业务</option>
                        <option value="translation">笔译</option>
                        <option value="interpretation">口译</option>
                        <option value="transcription">转录</option>
                        <option value="localization">本地化</option>
                        <option value="other">其他</option>
                    </select>
                    <select id="projectInvoiceStatusFilter" data-change="renderProjects()">
                        <option value="">全部开票状态</option>
                        <option value="none">未申请</option>
                        <option value="pending">待审批</option>
                        <option value="approved">已开票</option>
                        <option value="rejected">已拒绝</option>
                    </select>
                    <select id="projectPaymentStatusFilter" data-change="renderProjects()">
                        <option value="">全部回款状态</option>
                        <option value="unpaid">未支付</option>
                        <option value="partially_paid">部分支付</option>
                        <option value="paid">已支付</option>
                    </select>
                    <select id="projectCustomerFilter" data-change="renderProjects()">
                        <option value="">全部客户</option>
                    </select>
                    <select id="projectRoleFilter" data-change="onProjectRoleFilterChange()" style="display:none;">
                        <option value="">全部角色</option>
                    </select>
                    <select id="projectPageSize" data-change="renderProjects()">
                        <option value="10">每页10</option>
                        <option value="20">每页20</option>
                        <option value="50">每页50</option>
                    </select>
                </div>
                <div id="projectsList"></div>
            </div>

            <!-- KPI查询 -->
            <div id="kpi" class="section">
                <h2>KPI查询</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>选择月份</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="kpiYear" data-change="updateKpiMonth()" style="padding: 8px; min-width: 100px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; cursor: pointer;"></select>
                            <select id="kpiMonthSelect" data-change="updateKpiMonth()" style="padding: 8px; min-width: 100px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; cursor: pointer;"></select>
                        </div>
                        <input type="hidden" id="kpiMonth" value="">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>选择用户（管理员/财务可见）</label>
                        <select id="kpiUserSelect" data-change="loadKPI()" style="display:none;"></select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button data-click="generateMonthlyKPI()" id="generateKpiBtn" style="display:none;">生成月度KPI</button>
                        <button data-click="exportKPI()" id="exportKpiBtn" style="display:none;">导出Excel</button>
                    </div>
                </div>
                <div id="kpiResults"></div>
            </div>

            <!-- KPI配置 -->
            <div id="config" class="section">
                <h2>KPI系数配置</h2>
                <div id="configForm"></div>
                <div id="configAlert"></div>
                <div style="margin-top: 20px;">
                    <button data-click="loadConfigHistory()">查看变更历史</button>
                    <div id="configHistory" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- 权限配置 -->
            <div id="permissions" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>角色权限配置</h2>
                    <div style="display: flex; gap: 10px;">
                        <button data-click="loadRoles()" class="btn-small">刷新列表</button>
                        <button data-click="showCreateRoleModal()" class="btn-primary">创建新角色</button>
                    </div>
                </div>
                <div id="permissionsAlert"></div>
                <div id="rolesList" style="margin-top: 20px;"></div>
                <div id="permissionsConfig" style="margin-top: 20px;"></div>
            </div>

            <!-- 客户管理 -->
            <div id="customers" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>客户管理</h2>
                    <button data-click="showCreateCustomerModal()">创建新客户</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="customerSearch" placeholder="搜索客户名称、简称、联系人..." 
                           style="width: 300px; padding: 8px;" data-keyup="searchCustomers()">
                    <button data-click="searchCustomers()" style="margin-left: 10px;">搜索</button>
                </div>
                <div id="customersList"></div>
            </div>

            <!-- 用户管理 -->
            <div id="users" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>用户管理</h2>
                    <button data-click="showCreateUserModal()">创建新用户</button>
                </div>
                <div id="usersList"></div>
            </div>

            <!-- 数据备份 -->
            <div id="backup" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>数据备份与恢复</h2>
                    <div style="display: flex; gap: 10px;">
                        <button data-click="createBackup()" class="btn-success">创建备份</button>
                        <button data-click="cleanupOldBackups()" class="btn-small">清理旧备份</button>
                        <button data-click="loadBackups()" class="btn-small">刷新列表</button>
                    </div>
                </div>
                <div id="backupAlert" style="margin-bottom: 20px;"></div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">📋 备份说明</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #666;">
                        <li>系统每天00:00自动备份数据库</li>
                        <li>自动删除超过5天的旧备份</li>
                        <li>备份文件保存在服务器的 <code>backups</code> 目录</li>
                        <li><strong style="color: #d32f2f;">恢复操作会覆盖当前数据库，请谨慎操作！</strong></li>
                    </ul>
                </div>
                <div id="backupsList">
                    <div class="card-desc">加载中...</div>
                </div>
            </div>

            <!-- 语种管理 -->
            <div id="languages" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>语种管理</h2>
                    <button data-click="showCreateLanguageModal()" id="createLanguageBtn" style="display:none;">新增语种</button>
                </div>
                <div id="languagesList"></div>
            </div>

            <!-- 快递管理 -->
            <div id="express" class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
                    <h2 style="margin:0;">快递管理</h2>
                    <button class="btn-primary" data-click="showCreateExpressModal()">新建申请</button>
                </div>
                
                <!-- 标签页 -->
                <div class="tabs" style="margin-bottom:16px;border-bottom:2px solid #e5e7eb;">
                    <button class="tab express-tab active" data-tab="my" data-click="switchExpressTab('my')">我的申请</button>
                    <button class="tab express-tab" data-tab="manage" data-click="switchExpressTab('manage')" id="expressManageTab" style="display:none;">
                        申请管理
                        <span id="expressPendingBadge" class="badge badge-danger" style="display:none;margin-left:4px;">0</span>
                    </button>
                </div>
                
                <!-- 筛选区域 -->
                <div class="card" style="margin-bottom:16px;">
                    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
                        <select id="expressStatusFilter" style="padding:6px;" data-change="loadExpressList()">
                            <option value="">全部状态</option>
                            <option value="pending">待处理</option>
                            <option value="processing">处理中</option>
                            <option value="sent">已发出</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="expressCreatedByFilter" style="padding:6px;min-width:160px;display:none;" data-change="loadExpressList()">
                            <option value="">全部申请人</option>
                        </select>
                        <input type="date" id="expressStartDate" placeholder="开始日期" style="padding:6px;" data-change="loadExpressList()">
                        <input type="date" id="expressEndDate" placeholder="结束日期" style="padding:6px;" data-change="loadExpressList()">
                        <select id="expressPageSize" style="padding:6px;" data-change="loadExpressList()">
                            <option value="10">每页10</option>
                            <option value="20" selected>每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button data-click="loadExpressList()" style="padding:6px 12px;">刷新</button>
                    </div>
                </div>
                
                <!-- 列表区域 -->
                <div id="expressList"></div>
            </div>

            <!-- 办公用品采购管理 -->
            <div id="officeSupply" class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
                    <h2 style="margin:0;">办公用品采购管理</h2>
                    <button class="btn-primary" id="createOfficeSupplyBtn" data-click="showCreateOfficeSupplyModal()" style="display:none;">新建申请</button>
                </div>
                
                <!-- 标签页 -->
                <div class="tabs" style="margin-bottom:16px;border-bottom:2px solid #e5e7eb;">
                    <button class="tab office-supply-tab active" data-tab="my" data-click="switchOfficeSupplyTab('my')">我的申请</button>
                    <button class="tab office-supply-tab" data-tab="approve" data-click="switchOfficeSupplyTab('approve')" id="officeSupplyApproveTab" style="display:none;">
                        待审批
                        <span id="officeSupplyPendingBadge" class="badge badge-danger" style="display:none;margin-left:4px;">0</span>
                    </button>
                </div>
                
                <!-- 筛选区域 -->
                <div class="card" style="margin-bottom:16px;">
                    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
                        <select id="officeSupplyStatusFilter" style="padding:6px;" data-change="loadOfficeSupplyList()">
                            <option value="">全部状态</option>
                            <option value="pending">待审批</option>
                            <option value="approved">已批准</option>
                            <option value="rejected">已拒绝</option>
                            <option value="purchased">已采购</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="officeSupplyPageSize" style="padding:6px;" data-change="loadOfficeSupplyList()">
                            <option value="10">每页10</option>
                            <option value="20" selected>每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button data-click="loadOfficeSupplyList()" style="padding:6px 12px;">刷新</button>
                    </div>
                </div>
                
                <!-- 列表区域 -->
                <div id="officeSupplyList"></div>
            </div>

            <!-- 报销管理 -->
            <div id="expense" class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
                    <div>
                        <h2 style="margin:0;">报销管理</h2>
                        <p style="margin:4px 0 0;color:#666;">申请报销、审批报销申请</p>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn-primary" data-click="showCreateExpenseModal()" id="createExpenseBtn">新建申请</button>
                        <button data-click="loadExpenseList()" style="padding:6px 12px;">刷新</button>
                    </div>
                </div>
                <div class="card" style="margin-bottom:16px;">
                    <div style="display:flex;gap:8px;border-bottom:1px solid #e5e7eb;margin-bottom:12px;">
                        <button class="tab expense-tab active" data-tab="my" data-click="switchExpenseTab('my')">我的申请</button>
                        <button class="tab expense-tab" data-tab="approve" data-click="switchExpenseTab('approve')" id="expenseApproveTab" style="display:none;">待审批
                            <span id="expensePendingBadge" class="badge badge-danger" style="display:none;margin-left:4px;">0</span>
                        </button>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <select id="expenseStatusFilter" style="padding:6px;" data-change="loadExpenseList()">
                            <option value="">全部状态</option>
                            <option value="pending">待审批</option>
                            <option value="approved">已批准</option>
                            <option value="rejected">已拒绝</option>
                            <option value="paid">已支付</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="expenseTypeFilter" style="padding:6px;" data-change="loadExpenseList()">
                            <option value="">全部类型</option>
                            <option value="travel">差旅费</option>
                            <option value="meal">餐费</option>
                            <option value="transport">交通费</option>
                            <option value="office_supply">办公用品</option>
                            <option value="communication">通讯费</option>
                            <option value="other">其他</option>
                        </select>
                        <select id="expensePageSize" style="padding:6px;" data-change="loadExpenseList()">
                            <option value="10">每页10</option>
                            <option value="20" selected>每页20</option>
                            <option value="50">每页50</option>
                        </select>
                    </div>
                </div>
                <div id="expenseList"></div>
            </div>

            <!-- 章证使用管理 -->
            <div id="seal" class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
                    <h2 style="margin:0;">章证使用管理</h2>
                    <button class="btn-primary" data-click="showCreateSealModal()">新建申请</button>
                </div>
                
                <!-- 标签页 -->
                <div class="tabs" style="margin-bottom:16px;border-bottom:2px solid #e5e7eb;">
                    <button class="tab seal-tab active" data-tab="my" data-click="switchSealTab('my')">我的申请</button>
                    <button class="tab seal-tab" data-tab="manage" data-click="switchSealTab('manage')" id="sealManageTab" style="display:none;">
                        申请管理
                        <span id="sealPendingBadge" class="badge badge-danger" style="display:none;margin-left:4px;">0</span>
                    </button>
                </div>
                
                <!-- 筛选区域 -->
                <div class="card" style="margin-bottom:16px;">
                    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
                        <select id="sealStatusFilter" style="padding:6px;" data-change="loadSealList()">
                            <option value="">全部状态</option>
                            <option value="pending">待处理</option>
                            <option value="processing">使用中</option>
                            <option value="returned">已归还</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="sealTypeFilter" style="padding:6px;" data-change="loadSealList()">
                            <option value="">全部类型</option>
                            <option value="公章">公章</option>
                            <option value="合同章">合同章</option>
                            <option value="法人章">法人章</option>
                            <option value="财务章">财务章</option>
                            <option value="营业执照及复印件">营业执照及复印件</option>
                        </select>
                        <select id="sealPageSize" style="padding:6px;" data-change="loadSealList()">
                            <option value="10">每页10</option>
                            <option value="20" selected>每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button data-click="loadSealList()" style="padding:6px 12px;">刷新</button>
                    </div>
                </div>
                
                <!-- 列表区域 -->
                <div id="sealList"></div>
            </div>

            <!-- 个人中心 -->
            <div id="profile" class="section">
                <h2>个人中心</h2>
                <div id="profileAlert"></div>
                <div id="profileContent"></div>
            </div>

            <!-- 帮助文档 -->
            <div id="help" class="section">
                <!-- 内容由 help.js 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 模态框容器 -->
    <div id="modalOverlay" class="modal-overlay" data-click="closeModal()">
        <div class="modal-content" data-click="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">标题</h3>
                <button class="modal-close" data-click="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 动态内容 -->
            </div>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>
</html>
