<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI绩效管理系统</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- 登录页面 -->
    <div id="loginSection" class="container">
        <div class="login-form section active">
            <h2>登录</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit">登录</button>
            </form>
            <div id="loginAlert"></div>
        </div>
    </div>

    <!-- 主应用 -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <header>
                <h1>KPI绩效管理系统</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <button class="logout-btn" onclick="logout()">退出</button>
                </div>
            </header>

            <nav class="nav">
                <button onclick="showSection('dashboard')" class="active">业务看板</button>
                <button onclick="showSection('projects')">项目管理</button>
                <button onclick="showSection('customers')" id="customersBtn" style="display:none;">客户管理</button>
                <button onclick="showSection('kpi')">KPI查询</button>
                <button onclick="showSection('finance')" id="financeBtn" style="display:none;">财务管理</button>
                <button onclick="showSection('config')" id="configBtn" style="display:none;">KPI配置</button>
                <button onclick="showSection('users')" id="usersBtn" style="display:none;">用户管理</button>
                <button onclick="showSection('languages')" id="languagesBtn" style="display:none;">语种管理</button>
            </nav>

            <!-- 业务看板 -->
            <div id="dashboard" class="section active">
                <div id="dashboardTodayInfo" style="margin-bottom: 20px;"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="month" id="dashboardMonth" style="padding: 6px;" onchange="loadDashboard()">
                        <select id="dashboardStatus" style="padding: 6px;" onchange="loadDashboard()">
                            <option value="">全部状态</option>
                            <option value="pending">待开始</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="dashboardBusinessType" style="padding: 6px;" onchange="loadDashboard()">
                            <option value="">全部业务</option>
                            <option value="translation">笔译</option>
                            <option value="interpretation">口译</option>
                            <option value="transcription">转录</option>
                            <option value="localization">本地化</option>
                            <option value="other">其他</option>
                        </select>
                        <select id="dashboardRole" style="padding: 6px;" onchange="loadDashboard()">
                            <option value="">全部角色</option>
                            <option value="sales">销售</option>
                            <option value="pm">项目经理</option>
                            <option value="translator">翻译</option>
                            <option value="reviewer">审校</option>
                            <option value="admin_staff">综合岗</option>
                        </select>
                        <button onclick="loadDashboard()" style="padding: 6px 12px;">刷新</button>
                    </div>
                </div>
                <div id="dashboardCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px;"></div>
                <div id="dashboardCharts" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;"></div>
            </div>

            <!-- 财务管理 -->
            <div id="finance" class="section">
                <h2>财务管理</h2>
                <div class="card" style="margin-bottom:16px;">
                    <div class="card-title">应收对账</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="month" id="financeMonth" style="padding:6px;" onchange="loadReceivables()">
                        <select id="financeStatus" style="padding:6px;" onchange="loadReceivables()">
                            <option value="">全部状态</option>
                            <option value="pending">待开始</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="financePaymentStatus" style="padding:6px;" onchange="loadReceivables()">
                            <option value="">全部回款状态</option>
                            <option value="unpaid">未支付</option>
                            <option value="partially_paid">部分支付</option>
                            <option value="paid">已支付</option>
                        </select>
                        <select id="financeHasInvoice" style="padding:6px;" onchange="loadReceivables()">
                            <option value="">全部发票状态</option>
                            <option value="true">已开票</option>
                            <option value="false">未开票</option>
                        </select>
                        <select id="financeCustomer" style="padding:6px; min-width:160px;" onchange="loadReceivables()">
                            <option value="">全部客户</option>
                        </select>
                        <select id="financeSales" style="padding:6px; min-width:160px;" onchange="loadReceivables()">
                            <option value="">全部销售</option>
                        </select>
                        <select id="financePageSize" style="padding:6px;" onchange="renderReceivables()">
                            <option value="10">每页10</option>
                            <option value="20">每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button onclick="exportReceivables()" class="btn-small">导出当前筛选</button>
                        <button onclick="loadReceivables()" style="padding:6px 12px;">刷新</button>
                    </div>
                    <div id="receivablesList"></div>
                </div>

                <div class="card" style="margin-bottom:16px;">
                    <div class="card-title">回款记录</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="month" id="paymentMonth" style="padding:6px;" onchange="loadPaymentRecordsProjects()">
                        <select id="paymentStatusFilter" style="padding:6px;" onchange="loadPaymentRecordsProjects()">
                            <option value="">全部状态</option>
                            <option value="pending">待开始</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="paymentProjectPaymentStatus" style="padding:6px;" onchange="loadPaymentRecordsProjects()">
                            <option value="">全部回款状态</option>
                            <option value="unpaid">未支付</option>
                            <option value="partially_paid">部分支付</option>
                            <option value="paid">已支付</option>
                        </select>
                        <select id="paymentCustomer" style="padding:6px; min-width:160px;" onchange="loadPaymentRecordsProjects()">
                            <option value="">全部客户</option>
                        </select>
                        <select id="paymentSales" style="padding:6px; min-width:160px;" onchange="loadPaymentRecordsProjects()">
                            <option value="">全部销售</option>
                        </select>
                        <select id="paymentPageSize" style="padding:6px;" onchange="renderPaymentRecordsProjects()">
                            <option value="10">每页10</option>
                            <option value="20">每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button onclick="loadPaymentRecordsProjects()" style="padding:6px 12px;">刷新</button>
                    </div>
                    <div id="paymentProjectsList"></div>
                </div>
                
                <div class="card" style="margin-bottom:16px;">
                    <div class="card-title">新增回款</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <div style="position: relative; min-width: 300px;">
                            <input type="text" id="paymentProjectSearch" placeholder="搜索项目（编号/名称/客户）" 
                                   style="padding:6px; width:100%;" 
                                   onfocus="showProjectSelector('payment')"
                                   readonly>
                            <input type="hidden" id="paymentProjectId">
                            <div id="paymentProjectInfo" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
                        </div>
                        <input type="number" id="paymentAmount" placeholder="回款金额" step="0.01" min="0" style="padding:6px; width:120px;">
                        <input type="date" id="paymentDate" style="padding:6px;">
                        <select id="paymentMethod" style="padding:6px;">
                            <option value="bank">银行转账</option>
                            <option value="cash">现金</option>
                            <option value="alipay">支付宝</option>
                            <option value="wechat">微信</option>
                            <option value="other">其他</option>
                        </select>
                        <input type="text" id="paymentReference" placeholder="凭证号/备注" style="padding:6px; width:150px;">
                        <input type="text" id="paymentInvoiceNumber" placeholder="关联发票号（可选）" style="padding:6px; width:150px;">
                        <button onclick="addPaymentRecord()" style="padding:6px 12px;">新增回款</button>
                    </div>
                    <div id="paymentRecords"></div>
                </div>

                <div class="card" style="margin-bottom:16px;">
                    <div class="card-title">发票管理</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="month" id="invoiceMonth" style="padding:6px;" onchange="loadInvoiceProjects()">
                        <select id="invoiceStatusFilter" style="padding:6px;" onchange="loadInvoiceProjects()">
                            <option value="">全部状态</option>
                            <option value="pending">待开</option>
                            <option value="issued">已开</option>
                            <option value="paid">已支付</option>
                            <option value="void">作废</option>
                        </select>
                        <select id="invoiceTypeFilter" style="padding:6px;" onchange="loadInvoiceProjects()">
                            <option value="">全部类型</option>
                            <option value="vat">增值税发票</option>
                            <option value="normal">普通发票</option>
                            <option value="other">其他</option>
                        </select>
                        <select id="invoiceCustomer" style="padding:6px; min-width:160px;" onchange="loadInvoiceProjects()">
                            <option value="">全部客户</option>
                        </select>
                        <select id="invoiceSales" style="padding:6px; min-width:160px;" onchange="loadInvoiceProjects()">
                            <option value="">全部销售</option>
                        </select>
                        <select id="invoicePageSize" style="padding:6px;" onchange="renderInvoiceProjects()">
                            <option value="10">每页10</option>
                            <option value="20">每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button onclick="loadInvoiceProjects()" style="padding:6px 12px;">刷新</button>
                    </div>
                    <div id="invoiceProjectsList"></div>
                </div>
                
                <div class="card" style="margin-bottom:16px;">
                    <div class="card-title">新增发票</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <div style="position: relative; min-width: 300px;">
                            <input type="text" id="invoiceProjectSearch" placeholder="搜索项目（编号/名称/客户）" 
                                   style="padding:6px; width:100%;" 
                                   onfocus="showProjectSelector('invoice')"
                                   readonly>
                            <input type="hidden" id="invoiceProjectId">
                            <div id="invoiceProjectInfo" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
                        </div>
                        <input type="text" id="invoiceNumber" placeholder="发票号" style="padding:6px;min-width:120px;">
                        <input type="number" id="invoiceAmount" placeholder="金额" step="0.01" min="0" style="padding:6px; width:120px;">
                        <input type="date" id="invoiceDate" style="padding:6px;">
                        <select id="invoiceType" style="padding:6px;">
                            <option value="vat">增值税发票</option>
                            <option value="normal">普通发票</option>
                            <option value="other">其他</option>
                        </select>
                        <input type="text" id="invoiceNote" placeholder="备注" style="padding:6px; width:150px;">
                        <button onclick="addInvoice()" style="padding:6px 12px;">新增发票</button>
                    </div>
                </div>
                
                <div class="card" style="margin-bottom:16px;">
                    <div class="card-title">回款与发票对账</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="date" id="reconciliationStartDate" style="padding:6px;" placeholder="开始日期">
                        <input type="date" id="reconciliationEndDate" style="padding:6px;" placeholder="结束日期">
                        <button onclick="loadReconciliation()" style="padding:6px 12px;">查询对账</button>
                        <button onclick="exportReconciliation()" style="padding:6px 12px;">导出对账表</button>
                    </div>
                    <div id="reconciliationList"></div>
                </div>

                <div class="card" style="margin-bottom:16px;">
                    <div class="card-title">KPI审核待办</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="month" id="kpiPendingMonth" style="padding:6px;" onchange="loadPendingKpi()">
                        <button onclick="loadPendingKpi()" style="padding:6px 12px;">刷新</button>
                    </div>
                    <div id="pendingKpiList"></div>
                </div>

                <div class="card">
                    <div class="card-title">报表（按客户/销售）</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;">
                        <input type="month" id="reportMonth" style="padding:6px;" onchange="loadFinanceSummary()">
                        <button onclick="loadFinanceSummary()" style="padding:6px 12px;">刷新</button>
                    </div>
                    <div id="financeSummary"></div>
                </div>
            </div>

            <!-- 项目管理 -->
            <div id="projects" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap:10px; flex-wrap:wrap;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <h2 style="margin:0;">项目管理</h2>
                        <input type="text" id="projectSearch" placeholder="项目名/编号/客户" style="padding:8px; min-width:220px;" onkeyup="renderProjects()">
                        <select id="projectStatusFilter" style="padding:8px;" onchange="renderProjects()">
                            <option value="">全部状态</option>
                            <option value="pending">待开始</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                        <select id="projectBizFilter" style="padding:8px;" onchange="renderProjects()">
                            <option value="">全部业务</option>
                            <option value="translation">笔译</option>
                            <option value="interpretation">口译</option>
                            <option value="transcription">转录</option>
                            <option value="localization">本地化</option>
                            <option value="other">其他</option>
                        </select>
                        <select id="projectCustomerFilter" style="padding:8px; min-width:180px;" onchange="renderProjects()">
                            <option value="">全部客户</option>
                        </select>
                        <select id="projectPageSize" style="padding:8px;" onchange="renderProjects()">
                            <option value="10">每页10</option>
                            <option value="20">每页20</option>
                            <option value="50">每页50</option>
                        </select>
                        <button class="btn-small" onclick="exportProjects()">导出当前筛选</button>
                    </div>
                    <button onclick="showCreateProjectModal()" id="createProjectBtn" style="display:none;">创建新项目</button>
                </div>
                <div id="projectsList"></div>
            </div>

            <!-- KPI查询 -->
            <div id="kpi" class="section">
                <h2>KPI查询</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>选择月份</label>
                        <input type="month" id="kpiMonth" onchange="loadKPI()">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>选择用户（管理员/财务可见）</label>
                        <select id="kpiUserSelect" onchange="loadKPI()" style="display:none;"></select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button onclick="generateMonthlyKPI()" id="generateKpiBtn" style="display:none;">生成月度KPI</button>
                        <button onclick="exportKPI()" id="exportKpiBtn" style="display:none;">导出Excel</button>
                    </div>
                </div>
                <div id="kpiResults"></div>
            </div>

            <!-- KPI配置 -->
            <div id="config" class="section">
                <h2>KPI系数配置</h2>
                <div id="configForm"></div>
                <div id="configAlert"></div>
                <div style="margin-top: 20px;">
                    <button onclick="loadConfigHistory()">查看变更历史</button>
                    <div id="configHistory" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- 客户管理 -->
            <div id="customers" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>客户管理</h2>
                    <button onclick="showCreateCustomerModal()">创建新客户</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="customerSearch" placeholder="搜索客户名称、简称、联系人..." 
                           style="width: 300px; padding: 8px;" onkeyup="searchCustomers()">
                    <button onclick="searchCustomers()" style="margin-left: 10px;">搜索</button>
                </div>
                <div id="customersList"></div>
            </div>

            <!-- 用户管理 -->
            <div id="users" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>用户管理</h2>
                    <button onclick="showCreateUserModal()">创建新用户</button>
                </div>
                <div id="usersList"></div>
            </div>

            <!-- 语种管理 -->
            <div id="languages" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>语种管理</h2>
                    <button onclick="showCreateLanguageModal()" id="createLanguageBtn" style="display:none;">新增语种</button>
                </div>
                <div id="languagesList"></div>
            </div>
        </div>
    </div>

    <!-- 模态框容器 -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">标题</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 动态内容 -->
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
