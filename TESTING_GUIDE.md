# 系统测试指南

## 测试环境准备

### 1. 环境变量配置

确保 `.env` 文件包含以下配置：

```env
# 数据库
MONGODB_URI=mongodb://localhost:27017/kpi-system

# JWT
JWT_SECRET=your-secret-key

# 邮件服务（可选，用于测试邮件功能）
RESEND_API_KEY=re_xxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com
RESEND_FROM_NAME=语家 KPI 系统
APP_URL=http://localhost:3000
EMAIL_ENABLED=true

# 服务器
PORT=3000
NODE_ENV=development
```

### 2. 初始化数据

运行初始化脚本：

```bash
# 初始化管理员账号
node scripts/initAdmin.js

# 初始化角色和权限
node scripts/initRoles.js
```

### 3. 启动服务器

```bash
npm install
npm start
# 或开发模式
npm run dev
```

---

## 测试场景

### 场景 1：完整业务流程测试

#### 步骤 1：创建测试用户

1. 使用管理员账号登录
2. 创建以下测试用户：
   - 销售用户（sales）
   - 项目经理（pm）
   - 翻译（translator）
   - 审校（reviewer）
   - 财务（finance）

#### 步骤 2：创建客户

1. 使用销售账号登录
2. 创建测试客户：
   - 客户名称：测试客户A
   - 联系人：张三
   - 电话：13800138000
   - 邮箱：test@example.com

#### 步骤 3：创建项目

1. 使用销售账号登录
2. 创建项目：
   - 项目名称：测试项目001
   - 客户：测试客户A
   - 业务类型：笔译
   - 项目类型：MTPE
   - 源语种：英语
   - 目标语种：中文
   - 字数：10000
   - 单价：100
   - 项目金额：1000
   - 交付时间：未来7天
3. 添加项目成员：
   - 项目经理：选择PM用户
   - 翻译：选择翻译用户（MTPE，字数占比1.0）
4. 上传附件（可选）：
   - 选择一个测试文件（如 PDF、Word 文档）
5. 提交项目

**预期结果：**
- 项目创建成功
- 项目成员收到邮件通知（如果邮件服务已配置）
- 附件随邮件发送（如果有）

#### 步骤 4：项目执行

1. 使用项目经理账号登录
2. 查看项目列表，确认能看到"测试项目001"
3. 点击"查看"查看项目详情
4. 点击"开始项目"
5. 标记返修（可选）：
   - 点击"标记返修"
   - 填写返修原因
6. 标记延期（可选）：
   - 点击"标记延期"
   - 填写延期原因和新交付时间
7. 点击"完成项目"

**预期结果：**
- 项目状态正确更新
- 返修、延期信息正确记录

#### 步骤 5：生成 KPI

1. 使用管理员或财务账号登录
2. 进入"KPI 管理"页面
3. 选择当前月份
4. 点击"生成月度 KPI"

**预期结果：**
- KPI 记录生成成功
- 翻译、项目经理的 KPI 正确计算
- 返修、延期影响系数正确应用

#### 步骤 6：审核 KPI

1. 在 KPI 记录列表中找到生成的记录
2. 点击"审核"
3. 选择"通过"并确认

**预期结果：**
- KPI 状态更新为"已审核"

#### 步骤 7：导出 KPI

1. 点击"导出月度 KPI"
2. 下载 Excel 文件
3. 检查文件内容

**预期结果：**
- Excel 文件下载成功
- 数据格式正确
- 包含汇总和明细

---

### 场景 2：权限测试

#### 测试 2.1：销售权限

1. 使用销售账号登录
2. 创建客户和项目
3. 尝试查看其他销售创建的项目

**预期结果：**
- 只能看到自己创建的项目
- 可以看到自己创建的客户的完整信息
- 看不到其他销售创建的客户信息（或信息被脱敏）

#### 测试 2.2：项目经理权限

1. 使用项目经理账号登录
2. 查看项目列表

**预期结果：**
- 只能看到分配给自己的项目
- 看不到分配给其他项目经理的项目
- 客户联系信息被脱敏

#### 测试 2.3：翻译/审校权限

1. 使用翻译或审校账号登录
2. 查看项目列表

**预期结果：**
- 只能看到分配给自己的项目
- 客户联系信息被脱敏

#### 测试 2.4：财务权限

1. 使用财务账号登录
2. 查看项目列表、KPI、财务信息

**预期结果：**
- 可以看到所有项目
- 可以看到所有 KPI
- 可以管理发票和回款

---

### 场景 3：邮件功能测试

#### 测试 3.1：项目分配邮件

1. 确保邮件服务已配置
2. 创建项目并添加成员
3. 检查成员邮箱

**预期结果：**
- 成员收到邮件
- 邮件内容包含项目信息
- 附件正确发送（如果有）

#### 测试 3.2：单独添加成员邮件

1. 编辑项目
2. 添加新成员
3. 检查新成员邮箱

**预期结果：**
- 新成员收到邮件通知

---

### 场景 4：财务功能测试

#### 测试 4.1：申请开票

1. 使用销售账号登录
2. 找到已完成的项目
3. 点击"申请开票"
4. 填写申请信息并提交

**预期结果：**
- 申请提交成功
- 项目显示"待审批"状态

#### 测试 4.2：审批发票申请

1. 使用财务账号登录
2. 进入"财务管理"页面
3. 找到待审批的申请
4. 点击"批准"
5. 填写发票信息并确认

**预期结果：**
- 申请状态更新为"已开票"
- 发票记录创建成功

#### 测试 4.3：添加回款

1. 使用财务账号登录
2. 进入"财务管理"页面
3. 点击"添加回款"
4. 选择项目并填写回款信息

**预期结果：**
- 回款记录创建成功
- 项目回款状态更新

---

### 场景 5：数据脱敏测试

#### 测试 5.1：客户信息脱敏

1. 使用非销售角色（如项目经理）登录
2. 查看项目详情
3. 检查客户联系信息

**预期结果：**
- 联系人姓名、电话、邮箱显示为 *****

#### 测试 5.2：项目联系人脱敏

1. 使用非项目创建人角色登录
2. 查看项目详情
3. 检查项目联系人信息

**预期结果：**
- 联系人信息被脱敏

---

### 场景 6：错误处理测试

#### 测试 6.1：无效输入

1. 创建项目时留空必填字段
2. 提交表单

**预期结果：**
- 显示错误提示
- 表单不提交

#### 测试 6.2：权限不足

1. 使用普通用户尝试访问管理员功能
2. 尝试编辑不属于自己的项目

**预期结果：**
- 显示权限不足提示
- 操作被拒绝

#### 测试 6.3：文件上传错误

1. 上传超过 20MB 的文件
2. 上传多个文件，总大小超过 20MB

**预期结果：**
- 显示文件过大错误
- 文件不上传

---

## 性能测试

### 测试 1：大量数据加载

1. 创建 100+ 个项目
2. 加载项目列表

**预期结果：**
- 列表加载时间 < 3 秒
- 分页功能正常

### 测试 2：并发操作

1. 多个用户同时创建项目
2. 多个用户同时查看项目列表

**预期结果：**
- 系统响应正常
- 无数据冲突

---

## 回归测试检查清单

### 核心功能

- [ ] 用户登录和认证
- [ ] 用户管理（创建、编辑、删除）
- [ ] 客户管理（创建、编辑、联系人）
- [ ] 项目创建（包含附件上传）
- [ ] 项目成员管理
- [ ] 项目状态操作
- [ ] KPI 生成和计算
- [ ] KPI 审核
- [ ] 发票申请和审批
- [ ] 回款管理
- [ ] 邮件发送

### 权限控制

- [ ] 销售只能查看自己的项目
- [ ] 项目经理只能查看分配的项目
- [ ] 翻译/审校只能查看分配的项目
- [ ] 数据脱敏正确

### 边界情况

- [ ] 空数据列表
- [ ] 大量数据
- [ ] 特殊字符输入
- [ ] 文件上传限制
- [ ] 网络错误处理

---

## 测试报告模板

### 测试信息

- **测试日期**：YYYY-MM-DD
- **测试人员**：姓名
- **测试环境**：开发/测试/生产
- **测试版本**：v1.0.0

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 用户登录 | ✅/❌ | |
| 项目创建 | ✅/❌ | |
| KPI 生成 | ✅/❌ | |
| 邮件发送 | ✅/❌ | |
| ... | ... | |

### 发现的问题

1. **问题描述**
   - 严重程度：高/中/低
   - 复现步骤：
   - 预期结果：
   - 实际结果：

### 测试结论

- 通过/不通过
- 主要问题：
- 建议：

---

## 快速测试脚本

### 1. 创建测试数据脚本

```javascript
// scripts/createTestData.js
// 用于快速创建测试数据
```

### 2. 自动化测试

```bash
# 运行单元测试
npm test

# 运行集成测试（如果有）
npm run test:integration
```

---

**测试指南版本：** 1.0  
**最后更新：** 2025-12-20

