# 系统测试指南

## 测试环境准备

### 1. 环境变量配置

确保 `.env` 文件包含以下配置：

```env
# 数据库
MONGODB_URI=mongodb://localhost:27017/kpi-system

# JWT
JWT_SECRET=your-secret-key

# 邮件服务（可选，用于测试邮件功能）
RESEND_API_KEY=re_xxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com
RESEND_FROM_NAME=语家 KPI 系统
APP_URL=http://localhost:3000
EMAIL_ENABLED=true

# 服务器
PORT=3000
NODE_ENV=development
```

### 2. 初始化数据

运行初始化脚本：

```bash
# 初始化管理员账号
node scripts/initAdmin.js

# 初始化角色和权限
node scripts/initRoles.js
```

### 3. 启动服务器

```bash
npm install
npm start
# 或开发模式
npm run dev
```

---

## 测试场景

### 场景 1：完整业务流程测试

#### 步骤 1：创建测试用户

1. 使用管理员账号登录
2. 创建以下测试用户：
   - 销售用户（sales）
   - 项目经理（pm）
   - 翻译（translator）
   - 审校（reviewer）
   - 财务（finance）

#### 步骤 2：创建客户

1. 使用销售账号登录
2. 创建测试客户：
   - 客户名称：测试客户A
   - 联系人：张三
   - 电话：13800138000
   - 邮箱：test@example.com

#### 步骤 3：创建项目

**3.1 销售创建项目并添加项目经理**

1. 使用销售账号登录
2. 创建项目：
   - 项目名称：测试项目001
   - 客户：测试客户A
   - 业务类型：笔译
   - 项目类型：MTPE
   - 源语种：英语
   - 目标语种：中文
   - 字数：10000
   - 单价：100
   - 项目金额：1000
   - 交付时间：未来7天
3. 添加项目成员：
   - **注意：销售角色只能添加项目经理**
   - 项目经理：选择PM用户
4. 上传附件（可选）：
   - 选择一个测试文件（如 PDF、Word 文档）
5. 提交项目

**预期结果：**
- 项目创建成功
- 项目经理收到邮件通知（如果邮件服务已配置）
- 附件随邮件发送（如果有）
- 项目状态为"待安排"

**3.2 项目经理登录并添加生产成员**

1. **退出销售账号**
2. **使用项目经理账号登录**
3. **打开项目详情**，查看项目信息
4. **添加项目成员**：
   - 翻译：选择翻译用户（MTPE，字数占比1.0）
   - 审校：选择审校用户（字数占比1.0）
   - 排版：选择排版用户（可选，如果是兼职需要输入费用）
   - 其他角色：根据需要添加
5. **确认所有成员已添加**

**预期结果：**
- 项目经理可以成功添加翻译、审校、排版等生产成员
- 新添加的成员收到邮件通知（如果邮件服务已配置）
- 项目成员列表正确显示所有成员

#### 步骤 4：项目成员接受/拒绝

1. **退出项目经理账号**
2. **使用被添加的翻译账号登录**
3. **打开项目详情**，查看项目成员列表
4. **检查成员状态**：
   - 应该看到自己的成员记录
   - 状态应该显示"⏳ 待确认"
   - 应该能看到"接受"和"拒绝"按钮
5. **测试接受**：
   - 点击"接受"按钮
   - 状态应变为"✅ 已接受"，显示接受日期
   - 项目经理应收到通知
6. **测试拒绝**（可选，需要重新添加成员）：
   - 点击"拒绝"按钮
   - 输入拒绝原因（可选）
   - 状态应变为"❌ 已拒绝"，显示拒绝日期和原因
   - 项目经理应收到通知
   - 项目状态应保持"待安排"

**预期结果：**
- 成员能看到接受/拒绝按钮
- 接受后状态正确更新
- 拒绝后状态正确更新
- 项目经理收到通知

#### 步骤 5：项目状态自动流转

1. **确保所有生产成员已添加**（在步骤3.2中完成）
2. **等待所有成员接受**（或使用成员账号逐一接受）
3. **检查项目状态**：
   - 当所有生产人员都接受后，项目状态应自动变为"进行中"
   - 如果有成员拒绝，项目状态应保持"待安排"
   - 如果还有成员未接受，项目状态应保持"待安排"

**预期结果：**
- 所有成员接受后，项目状态自动变为"进行中"
- 有成员拒绝时，项目状态保持"待安排"
- 有成员未接受时，项目状态保持"待安排"

#### 步骤 6：项目执行

1. 使用项目经理账号登录
2. 查看项目列表，确认能看到"测试项目001"
3. 点击"查看"查看项目详情
4. 标记返修（可选）：
   - 点击"标记返修"
   - 填写返修原因
5. 标记延期（可选）：
   - 点击"标记延期"
   - 填写延期原因和新交付时间
6. 点击"完成项目"

**预期结果：**
- 项目状态正确更新
- 返修、延期信息正确记录
- 完成项目前会检查所有成员是否都已接受

#### 步骤 7：生成 KPI

1. 使用管理员或财务账号登录
2. 进入"KPI 管理"页面
3. 选择当前月份
4. 点击"生成月度 KPI"

**预期结果：**
- KPI 记录生成成功
- 翻译、项目经理的 KPI 正确计算
- 返修、延期影响系数正确应用
- 兼职角色（除兼职销售外）的费用直接使用，不计算KPI
- 兼职销售计算返还佣金
- 综合岗和财务岗跳过项目级计算，在月度汇总时使用管理员评价的完成系数

#### 步骤 8：员工确认 KPI（专职/兼职）

**8.1 专职员工确认KPI**

1. 使用专职员工账号（如翻译、审校、项目经理等）登录
2. 进入"KPI 管理"页面
3. 选择要确认的月份（默认显示上一个月）
4. 点击"我的KPI确认"按钮
5. 查看专职KPI记录列表
6. 对每条记录执行以下操作：
   - **确认无误**：点击"确认无误"按钮
   - **有异议**：点击"有异议"按钮，填写异议原因，确认

**预期结果：**
- 显示该月份的所有专职KPI记录
- 每条记录显示：项目名称、角色、KPI（分）、状态、操作按钮
- 点击"确认无误"后，状态更新为"已确认"
- 点击"有异议"后，状态更新为"有异议"，并记录异议原因
- 已确认的记录不能再修改

**8.2 兼职员工确认费用**

1. 使用兼职员工账号（如兼职排版、兼职翻译等）登录
2. 进入"KPI 管理"页面
3. 选择要确认的月份（默认显示上一个月）
4. 点击"我的KPI确认"按钮
5. 查看兼职费用记录列表
6. 对每条记录执行确认操作

**预期结果：**
- 显示该月份的所有兼职费用记录（包括已生成KPI记录和未生成KPI记录的）
- 每条记录显示：项目名称、角色、费用（元）、状态、操作按钮
- 未生成KPI记录的兼职费用也能显示（从ProjectMember查询）
- 确认后自动生成对应的KpiRecord
- 兼职费用按"元"显示

**8.3 月份选择功能**

1. 在"KPI 管理"页面选择月份（如2024-12）
2. 点击"我的KPI确认"按钮
3. 查看显示的记录

**预期结果：**
- 显示所选月份的KPI记录
- 如果未选择月份，默认显示上一个月

**8.4 确认状态显示**

1. 查看"我的KPI确认"页面
2. 检查不同状态的显示

**预期结果：**
- 待确认：显示"待确认"标签（黄色）
- 已确认：显示"已确认"标签（绿色），操作按钮隐藏
- 有异议：显示"有异议"标签（红色），操作按钮隐藏

#### 步骤 9：审核 KPI

1. 在 KPI 记录列表中找到生成的记录
2. 点击"审核"
3. 选择"通过"并确认

**预期结果：**
- KPI 状态更新为"已审核"

#### 步骤 10：导出 KPI（含确认校验）

**10.1 导出前确认校验**

1. 生成月度KPI后，不进行员工确认
2. 尝试导出该月份的KPI
3. 检查系统提示

**预期结果：**
- 导出失败，提示"还有 X 条记录未确认"
- 显示未确认记录涉及的员工列表
- 提示用户先完成确认后再导出

**10.2 完成确认后导出**

1. 所有员工完成KPI确认（专职KPI和兼职费用）
2. 使用管理员或财务账号登录
3. 选择月份
4. 点击"导出月度 KPI"
5. 下载 Excel 文件
6. 检查文件内容

**预期结果：**
- 导出成功
- Excel 文件下载成功
- 数据格式正确
- 包含汇总和明细
- 包含确认状态信息

**10.3 部分确认情况**

1. 部分员工完成确认，部分员工未确认
2. 尝试导出

**预期结果：**
- 导出失败
- 提示未确认记录数量和涉及的员工
- 只有所有记录都确认后才能导出

---

### 场景 2：权限测试

#### 测试 2.1：销售权限

1. 使用销售账号登录
2. 创建客户和项目
3. 尝试查看其他销售创建的项目

**预期结果：**
- 只能看到自己创建的项目
- 可以看到自己创建的客户的完整信息
- 看不到其他销售创建的客户信息（或信息被脱敏）

#### 测试 2.2：项目经理权限

1. 使用项目经理账号登录
2. 查看项目列表

**预期结果：**
- 只能看到分配给自己的项目
- 看不到分配给其他项目经理的项目
- 客户联系信息被脱敏

#### 测试 2.3：翻译/审校权限

1. 使用翻译或审校账号登录
2. 查看项目列表

**预期结果：**
- 只能看到分配给自己的项目
- 客户联系信息被脱敏

#### 测试 2.5：财务权限

1. 使用财务账号登录
2. 查看项目列表、KPI、财务信息

**预期结果：**
- 可以看到所有项目
- 可以看到所有 KPI
- 可以管理发票和回款

---

### 场景 3：邮件功能测试

#### 测试 3.1：项目分配邮件

1. 确保邮件服务已配置
2. 创建项目并添加成员
3. 检查成员邮箱

**预期结果：**
- 成员收到邮件
- 邮件内容包含项目信息
- 附件正确发送（如果有）

#### 测试 3.2：单独添加成员邮件

1. 编辑项目
2. 添加新成员
3. 检查新成员邮箱

**预期结果：**
- 新成员收到邮件通知

---

### 场景 4：报销管理功能测试

#### 测试 4.1：创建报销申请

1. 使用专职人员账号登录（如销售、项目经理等）
2. 进入"报销管理"页面
3. 点击"新建申请"按钮
4. 填写报销信息：
   - 费用类型：差旅费
   - 添加费用明细：
     - 日期：今天
     - 金额：500
     - 说明：出差住宿费
     - 发票号：INV001
     - 上传发票照片（可选）
   - 申请说明：出差报销
5. 提交申请

**预期结果：**
- 申请提交成功
- 状态为"待审批"
- 财务和管理员收到邮件通知（包含发票照片）

#### 测试 4.2：查看我的申请

1. 在"我的申请"标签页查看
2. 筛选不同状态和费用类型

**预期结果：**
- 只显示自己提交的申请
- 筛选功能正常

#### 测试 4.3：审批报销申请

1. 使用财务或管理员账号登录
2. 进入"报销管理"页面
3. 在"待审批"标签页查看待审批的申请
4. 点击"查看"查看申请详情
5. 点击"批准"或"拒绝"：
   - 批准：填写审批意见，确认
   - 拒绝：填写拒绝原因，确认

**预期结果：**
- 审批操作成功
- 申请状态正确更新
- 申请人收到通知

#### 测试 4.4：标记已支付

1. 使用财务或管理员账号登录
2. 找到状态为"已批准"的申请
3. 点击"标记已支付"
4. 填写支付信息（可选）
5. 确认

**预期结果：**
- 状态更新为"已支付"
- 申请人收到通知

#### 测试 4.5：取消申请

1. 使用申请人账号登录
2. 找到状态为"待审批"或"已拒绝"的申请
3. 点击"取消"
4. 填写取消原因（可选）
5. 确认

**预期结果：**
- 状态更新为"已取消"
- 只有符合条件的申请可以取消

#### 测试 4.6：发票照片上传

1. 创建报销申请时
2. 在费用明细中上传发票照片
3. 可以上传多个文件
4. 测试文件大小限制（超过 20MB 应提示错误）

**预期结果：**
- 文件读取成功
- 文件大小验证正确
- 提交后邮件包含附件

#### 测试 4.7：兼职人员权限

1. 使用兼职人员账号登录
2. 尝试创建报销申请

**预期结果：**
- 不能创建报销申请
- 显示权限不足提示

---

### 场景 5：财务功能测试

#### 测试 4.1：申请开票

1. 使用销售账号登录
2. 找到已完成的项目
3. 点击"申请开票"
4. 填写申请信息并提交

**预期结果：**
- 申请提交成功
- 项目显示"待审批"状态

#### 测试 4.2：审批发票申请

1. 使用财务账号登录
2. 进入"财务管理"页面
3. 找到待审批的申请
4. 点击"批准"
5. 填写发票信息并确认

**预期结果：**
- 申请状态更新为"已开票"
- 发票记录创建成功

#### 测试 4.3：添加回款

1. 使用财务账号登录
2. 进入"财务管理"页面
3. 点击"添加回款"
4. 选择项目并填写回款信息

**预期结果：**
- 回款记录创建成功
- 项目回款状态更新

#### 测试 5.4：现金/支付宝/微信收款人校验

1. 使用财务账号登录
2. 进入"新增回款"
3. 选择支付方式为现金/支付宝/微信
4. 不选择收款人提交

**预期结果：**
- 提示收款人必填且需为项目成员中的财务/销售/兼职销售

---

### 场景 6：数据脱敏测试

#### 测试 5.1：客户信息脱敏

1. 使用非销售角色（如项目经理）登录
2. 查看项目详情
3. 检查客户联系信息

**预期结果：**
- 联系人姓名、电话、邮箱显示为 *****

#### 测试 5.2：项目联系人脱敏

1. 使用非项目创建人角色登录
2. 查看项目详情
3. 检查项目联系人信息

**预期结果：**
- 联系人信息被脱敏

---

### 场景 7：错误处理测试

#### 测试 6.1：无效输入

1. 创建项目时留空必填字段
2. 提交表单

**预期结果：**
- 显示错误提示
- 表单不提交

#### 测试 6.2：权限不足

1. 使用普通用户尝试访问管理员功能
2. 尝试编辑不属于自己的项目

**预期结果：**
- 显示权限不足提示
- 操作被拒绝

#### 测试 6.3：文件上传错误

1. 上传超过 20MB 的文件
2. 上传多个文件，总大小超过 20MB

**预期结果：**
- 显示文件过大错误
- 文件不上传

---

### 场景 8：评价与反馈（逆向评价）

1. 准备已完成的项目，成员包含销售、PM、翻译/审校/排版
2. 使用 PM 账号在项目详情提交对销售的评价（可选匿名）
3. 使用翻译/审校/排版账号提交对 PM 的评价
4. 查看项目评价列表与“我的评价统计”

**预期结果：**
- 仅已完成且在允许时间窗口（默认 30 天）内的项目可提交评价
- 保存成功且不影响 KPI 计算
- 查看评价列表时遵守匿名/脱敏规则（如适用）

---

### 场景 9：合同导出

1. 使用管理员/项目创建人/项目经理进入项目详情
2. 点击“导出合同”

**预期结果：**
- 成功下载 Word 合同文件
- 客户与联系人信息按权限脱敏（非管理员且非创建销售不可见明文）
- 特殊要求含“打印盖章并快递”显示正确

---

### 场景 10：业务看板回款预警跳转

1. 打开业务看板
2. 点击“回款预警”卡片
3. 点击“近7天回款预警”卡片

**预期结果：**
- 跳转到项目列表并自动只显示对应预警项目（不进入财务模块）
- 可继续查看、导出等操作
- 金额显示遵循角色：管理员/财务可见全部；销售仅可见自己创建项目的金额/回款；综合岗不显示金额

---

### 场景 11：特殊要求（打印盖章并快递）

1. 创建或编辑项目时勾选"打印盖章并快递"，填写备注
2. 保存后在项目详情查看特殊要求展示
3. 未勾选时默认不显示该标签

**预期结果：**
- 新增选项保存并展示正确
- 其他特殊要求保持正常

---

### 场景 12：项目成员接受/拒绝功能

#### 测试 12.1：成员接受项目

1. 使用项目经理账号登录
2. 创建项目并添加翻译成员"张三"
3. 退出，使用"张三"账号登录
4. 打开项目详情，查看成员列表
5. 点击"接受"按钮

**预期结果：**
- 显示成功提示信息
- 成员状态变为"✅ 已接受"
- 显示接受日期
- 项目经理和项目创建者收到通知

#### 测试 12.2：成员拒绝项目

1. 使用项目经理账号登录
2. 创建项目并添加审校成员"李四"
3. 退出，使用"李四"账号登录
4. 打开项目详情，查看成员列表
5. 点击"拒绝"按钮
6. 输入拒绝原因（可选）

**预期结果：**
- 显示成功提示信息
- 成员状态变为"❌ 已拒绝"
- 显示拒绝日期和原因
- 项目经理和项目创建者收到通知
- 项目状态保持"待安排"

#### 测试 12.3：项目状态自动流转

1. 创建项目并添加翻译"张三"和审校"李四"
2. 张三接受 → 项目状态仍为"待安排"（还有李四未接受）
3. 李四接受 → 项目状态自动变为"进行中"

**预期结果：**
- 所有生产角色都有有效成员且都已接受后，项目状态自动变为"进行中"

#### 测试 12.4：拒绝后重新安排

1. 创建项目并添加翻译"张三"（接受）和审校"李四"（拒绝）
2. 项目状态应为"待安排"
3. 删除拒绝的成员"李四"
4. 添加新审校"王五"
5. 王五接受

**预期结果：**
- 项目状态自动变为"进行中"（所有角色都有有效成员且都已接受）

#### 测试 12.5：多角色拒绝测试

1. 创建项目并添加多个生产人员
2. 多个成员拒绝
3. 重新安排所有拒绝的角色
4. 所有新成员接受

**预期结果：**
- 项目状态正确流转
- 每个角色都需要有有效成员且都已接受

---

### 场景 13：动态角色管理测试

#### 测试 13.1：创建新角色

1. 使用管理员账号登录
2. 进入"系统配置" → "角色管理"
3. 点击"创建角色"
4. 填写角色信息：
   - 角色代码：test_role
   - 角色名称：测试角色
   - 设置为：可用于项目成员、可用于KPI记录、非管理角色、非固定角色、非特殊角色
5. 配置权限
6. 创建角色

**预期结果：**
- 角色创建成功
- 新角色显示在角色列表中
- 新角色可以用于项目成员
- 新角色显示在KPI配置页面的新角色配置区域

#### 测试 13.2：配置新角色KPI系数

1. 进入"系统配置" → "KPI系数配置"
2. 在"角色KPI系数配置"区域找到新创建的角色
3. 输入KPI系数（如0.05）
4. 点击"更新配置"

**预期结果：**
- 新角色的系数配置成功
- 创建项目时，新角色的系数会自动锁定到项目中

#### 测试 13.3：使用新角色作为项目成员

1. 创建项目
2. 添加成员时，选择新创建的角色
3. 选择用户
4. 添加成员

**预期结果：**
- 新角色可以正常添加为项目成员
- 如果新角色设置为非管理角色，成员需要确认
- 如果新角色设置为管理角色，成员自动接受

#### 测试 13.4：新角色KPI计算

1. 创建项目并添加新角色成员
2. 完成项目
3. 生成月度KPI
4. 查看KPI记录

**预期结果：**
- 新角色的KPI使用配置的系数计算
- KPI记录正确生成

### 场景 14：兼职费用管理测试

#### 测试 14.1：添加兼职排版成员

1. 创建项目
2. 添加成员时：
   - 选择"排版"角色
   - 选择兼职用户
3. 检查费用输入字段

**预期结果：**
- 只显示"兼职排版费用（元）"字段
- 不显示"排版费用（元）"字段（专职排版字段）
- 费用输入字段为必填

#### 测试 14.2：添加专职排版成员

1. 创建项目
2. 添加成员时：
   - 选择"排版"角色
   - 选择专职用户
3. 检查费用输入字段

**预期结果：**
- 只显示"排版费用（元）"字段（专职排版字段）
- 不显示"兼职排版费用（元）"字段
- 费用输入字段为可选

#### 测试 14.3：兼职费用验证

1. 添加兼职排版成员
2. 输入费用：
   - 测试1：费用为0 → 应提示错误
   - 测试2：费用超过项目金额 → 应提示错误
   - 测试3：费用超过项目金额的5% → 应提示错误（仅排版角色）
   - 测试4：费用在合理范围内 → 应成功

**预期结果：**
- 费用验证正确
- 错误提示清晰

#### 测试 14.4：兼职费用KPI计算

1. 创建项目并添加兼职排版成员（输入费用1000元）
2. 完成项目
3. 生成月度KPI
4. 查看KPI记录

**预期结果：**
- 兼职排版的KPI记录中，kpiValue = 1000（费用值）
- formula显示"兼职排版费用：1000元"
- 在KPI查询页面显示为"兼职费用（元）"

#### 测试 14.5：专职兼职费用显示

1. 在项目详情页面查看成员列表
2. 检查费用显示

**预期结果：**
- 兼职排版显示"兼职排版费用：¥1000.00"
- 专职排版显示"排版费用：¥500.00"（如果有）
- 兼职翻译显示"兼职翻译费用：¥800.00"（如果有）

### 场景 16：KPI配置页面测试

#### 测试 16.1：查看KPI配置页面

1. 使用管理员账号登录
2. 进入"系统配置" → "KPI系数配置"
3. 查看"角色KPI系数配置"区域

**预期结果：**
- 固定角色（翻译、审校、PM、销售、综合岗、财务）的系数在上面已配置
- 新角色（如test角色）显示在下方配置区域
- 如果没有任何可配置的新角色，显示提示信息

#### 测试 16.2：配置新角色系数

1. 在"角色KPI系数配置"区域找到新角色
2. 输入系数值
3. 点击"更新配置"

**预期结果：**
- 系数配置成功
- 创建项目时，新角色的系数自动锁定

#### 测试 16.3：角色过滤逻辑

1. 创建不同属性的角色：
   - 角色A：isSystem=true → 不应显示
   - 角色B：isFixedRole=true → 不应显示
   - 角色C：isSpecialRole=true → 不应显示
   - 角色D：canBeKpiRole=false → 不应显示
   - 角色E：所有属性都为false，canBeKpiRole=true → 应显示
2. 查看KPI配置页面

**预期结果：**
- 只有角色E显示在配置列表中
- 其他角色不显示

### 场景 17：专职兼职KPI显示测试

#### 测试 17.1：KPI查询页面显示

1. 生成包含专职和兼职角色的KPI记录
2. 进入"KPI管理"页面
3. 选择"全部用户"和月份
4. 查看汇总显示

**预期结果：**
- 专职KPI和兼职费用分开显示
- 专职KPI按"分"显示
- 兼职费用按"元"显示
- 汇总表格正确分类

#### 测试 17.2：财务模块显示

1. 进入"财务管理"页面
2. 查看KPI审核列表
3. 检查专职/兼职显示

**预期结果：**
- 专职KPI显示为"分"
- 兼职费用显示为"元"
- 单位标识正确

---

### 场景 18：KPI确认功能测试

#### 测试 18.1：专职员工确认KPI

1. 创建项目并添加专职成员（翻译、审校、项目经理等）
2. 完成项目
3. 生成月度KPI
4. 使用专职员工账号登录
5. 进入"KPI 管理"页面
6. 选择要确认的月份
7. 点击"我的KPI确认"按钮
8. 查看专职KPI记录列表
9. 测试确认操作：
   - 点击"确认无误"按钮
   - 检查状态是否更新为"已确认"
10. 测试异议操作：
    - 点击"有异议"按钮
    - 填写异议原因（如"KPI计算有误"）
    - 确认
    - 检查状态是否更新为"有异议"

**预期结果：**
- 显示该月份的所有专职KPI记录
- 每条记录显示：项目名称、角色、KPI（分）、状态、操作按钮
- "确认无误"操作成功，状态更新为"已确认"
- "有异议"操作成功，状态更新为"有异议"，异议原因被记录
- 已确认的记录不能再修改（操作按钮隐藏）
- 有异议的记录不能再修改（操作按钮隐藏）

#### 测试 18.2：兼职员工确认费用（已生成KPI记录）

1. 创建项目并添加兼职成员（兼职排版、兼职翻译等），输入兼职费用
2. 完成项目
3. 生成月度KPI
4. 使用兼职员工账号登录
5. 进入"KPI 管理"页面
6. 选择要确认的月份
7. 点击"我的KPI确认"按钮
8. 查看兼职费用记录列表
9. 执行确认操作

**预期结果：**
- 显示该月份的所有兼职费用记录
- 每条记录显示：项目名称、角色、费用（元）、状态、操作按钮
- 费用按"元"显示
- 确认操作成功

#### 测试 18.3：兼职员工确认费用（未生成KPI记录）

1. 创建项目并添加兼职成员（兼职排版），输入兼职费用200元
2. 完成项目（项目完成时间或创建时间为目标月份）
3. **不生成月度KPI**（模拟未生成KPI记录的情况）
4. 使用兼职员工账号登录
5. 进入"KPI 管理"页面
6. 选择目标月份
7. 点击"我的KPI确认"按钮
8. 查看兼职费用记录列表
9. 执行确认操作

**预期结果：**
- 显示未生成KPI记录的兼职费用（从ProjectMember查询）
- 记录显示为"待确认"状态
- 点击"确认无误"后，自动生成对应的KpiRecord
- 生成后的KpiRecord状态为"已确认"
- 费用值正确（200元）

#### 测试 18.4：月份选择功能

1. 在"KPI 管理"页面选择月份（如2024-12）
2. 点击"我的KPI确认"按钮
3. 检查显示的记录

**预期结果：**
- 显示所选月份的KPI记录
- 如果未选择月份，默认显示上一个月
- 月份选择器与KPI查询页面共享

#### 测试 18.5：确认状态显示

1. 查看"我的KPI确认"页面
2. 检查不同状态的显示

**预期结果：**
- 待确认：显示"待确认"标签（黄色），显示操作按钮
- 已确认：显示"已确认"标签（绿色），操作按钮隐藏
- 有异议：显示"有异议"标签（红色），操作按钮隐藏

#### 测试 18.6：权限验证

1. 使用用户A的账号登录
2. 尝试确认用户B的KPI记录（通过API直接调用）

**预期结果：**
- 只能确认自己的KPI记录
- 尝试确认他人记录时返回403错误

#### 测试 18.7：财务导出前确认校验

1. 生成月度KPI
2. **不进行员工确认**
3. 使用管理员或财务账号登录
4. 尝试导出该月份的KPI
5. 检查系统提示

**预期结果：**
- 导出失败
- 提示"还有 X 条记录未确认"
- 显示未确认记录涉及的员工列表（最多显示10个）
- 提示用户先完成确认后再导出

#### 测试 18.8：完成确认后导出

1. 所有员工完成KPI确认（专职KPI和兼职费用）
2. 使用管理员或财务账号登录
3. 选择月份
4. 点击"导出月度 KPI"
5. 检查导出是否成功

**预期结果：**
- 导出成功
- Excel 文件下载成功
- 数据格式正确
- 包含汇总和明细

#### 测试 18.9：部分确认情况

1. 生成月度KPI
2. 部分员工完成确认，部分员工未确认
3. 尝试导出

**预期结果：**
- 导出失败
- 提示未确认记录数量和涉及的员工
- 只有所有记录都确认后才能导出

#### 测试 18.10：空记录情况

1. 选择没有KPI记录的月份
2. 点击"我的KPI确认"按钮

**预期结果：**
- 显示"本月暂无记录"提示
- 专职KPI和兼职费用分别显示空记录提示

---

### 场景 19：项目成员确认功能测试（更新）

#### 测试 18.1：管理角色自动接受

1. 创建项目
2. 添加项目经理成员（管理角色）
3. 检查成员状态

**预期结果：**
- 项目经理成员状态自动为"已接受"
- 不需要确认

#### 测试 18.2：新角色确认逻辑

1. 创建新角色，设置isManagementRole=true
2. 创建项目并添加该角色成员
3. 检查成员状态

**预期结果：**
- 新角色成员状态自动为"已接受"（因为是管理角色）
- 不需要确认

#### 测试 18.3：新角色需要确认

1. 创建新角色，设置isManagementRole=false
2. 创建项目并添加该角色成员
3. 检查成员状态

**预期结果：**
- 新角色成员状态为"待确认"
- 需要成员主动接受

#### 测试 13.1：顶部角色切换

1. 创建一个同时拥有翻译和审校角色的用户
2. 为该用户分配不同角色的项目：
   - 作为翻译参与项目A
   - 作为审校参与项目B
3. 登录该用户账号
4. 在顶部切换角色：
   - 切换到"翻译"角色 → 项目列表应只显示项目A
   - 切换到"审校"角色 → 项目列表应只显示项目B

**预期结果：**
- 顶部切换角色时，项目列表自动根据当前角色过滤
- 角色筛选器自动同步当前角色

#### 测试 13.2：角色筛选器

1. 使用多角色用户登录
2. 在项目列表的角色筛选器中选择：
   - 选择"翻译" → 应只显示作为翻译成员参与的项目
   - 选择"审校" → 应只显示作为审校成员参与的项目
   - 选择"全部角色" → 应显示所有角色参与的项目

**预期结果：**
- 角色筛选器正确显示和过滤
- 拒绝的成员不显示在项目列表中

#### 测试 13.3：拒绝成员过滤

1. 创建项目并添加成员：
   - 作为翻译参与项目C，接受
   - 作为审校参与项目D，拒绝
2. 测试过滤：
   - 切换到"翻译"角色 → 应显示项目C
   - 切换到"审校"角色 → 不应显示项目D（因为已拒绝）
   - 选择"审校"筛选器 → 不应显示项目D

**预期结果：**
- 拒绝的成员不显示在项目列表中
- 后端查询时自动排除拒绝的成员

---

## 性能测试

### 测试 1：大量数据加载

1. 创建 100+ 个项目
2. 加载项目列表

**预期结果：**
- 列表加载时间 < 3 秒
- 分页功能正常

### 测试 2：并发操作

1. 多个用户同时创建项目
2. 多个用户同时查看项目列表

**预期结果：**
- 系统响应正常
- 无数据冲突

---

## 回归测试检查清单

### 核心功能

- [ ] 用户登录和认证
- [ ] 用户管理（创建、编辑、删除）
- [ ] 客户管理（创建、编辑、联系人）
- [ ] 项目创建（包含附件上传）
- [ ] 项目成员管理（包含兼职费用输入）
- [ ] 项目成员接受/拒绝功能
- [ ] 项目状态自动流转（根据成员接受情况）
- [ ] 项目状态操作
- [ ] KPI 生成和计算（包含专职/兼职区分）
- [ ] KPI 审核
- [ ] KPI 查询（专职KPI和兼职费用分类显示）
- [ ] KPI 确认（专职员工确认KPI，兼职员工确认费用）
- [ ] KPI 导出前确认校验
- [ ] 发票申请和审批
- [ ] 回款管理
- [ ] 报销申请创建（包含发票照片上传）
- [ ] 报销申请审批
- [ ] 报销申请支付标记
- [ ] 邮件发送（项目分配、附件、报销申请）
- [ ] 评价与反馈（PM→销售、执行→PM）
- [ ] 合同导出
- [ ] 回款预警跳转项目列表
- [ ] 特殊要求：打印盖章并快递
- [ ] 角色管理（创建、编辑、配置属性）
- [ ] KPI系数配置（固定角色和新角色）

### 权限控制

- [ ] 销售只能查看自己的项目
- [ ] 销售回款/金额仅限自己创建的项目
- [ ] 项目经理只能查看分配的项目
- [ ] 翻译/审校只能查看分配的项目
- [ ] 多角色用户切换角色时项目列表正确过滤
- [ ] 拒绝的成员不显示在项目列表中
- [ ] 数据脱敏正确
- [ ] 动态角色权限正确应用
- [ ] 管理角色自动接受，生产角色需要确认

### 边界情况

- [ ] 空数据列表
- [ ] 大量数据
- [ ] 特殊字符输入
- [ ] 文件上传限制
- [ ] 网络错误处理

---

## 测试报告模板

### 测试信息

- **测试日期**：YYYY-MM-DD
- **测试人员**：姓名
- **测试环境**：开发/测试/生产
- **测试版本**：v1.0.0

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 用户登录 | ✅/❌ | |
| 项目创建 | ✅/❌ | |
| KPI 生成 | ✅/❌ | |
| 邮件发送 | ✅/❌ | |
| ... | ... | |

### 发现的问题

1. **问题描述**
   - 严重程度：高/中/低
   - 复现步骤：
   - 预期结果：
   - 实际结果：

### 测试结论

- 通过/不通过
- 主要问题：
- 建议：

---

## 快速测试脚本

### 1. 创建测试数据脚本

```javascript
// scripts/createTestData.js
// 用于快速创建测试数据
```

### 2. 自动化测试

```bash
# 运行单元测试
npm test

# 运行集成测试（如果有）
npm run test:integration
```

---

**测试指南版本：** 1.3  
**最后更新：** 2025-01-15

## 更新日志

### v1.3 (2025-01-15)
- 新增动态角色管理测试场景
- 新增兼职费用管理测试场景
- 新增KPI配置页面测试场景
- 新增专职兼职KPI显示测试场景
- 更新项目成员确认功能测试（支持动态角色）
- 更新KPI计算规则说明（包含专职/兼职区分）
- 更新测试检查清单

### v1.2 (2025-12-25)
- 新增项目成员接受/拒绝功能测试场景
- 新增项目状态自动流转测试场景
- 新增多角色用户角色筛选测试场景
- 更新测试检查清单

