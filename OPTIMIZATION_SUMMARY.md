# 业务逻辑优化总结

本文档记录了针对系统业务逻辑的优化改进。

## 优化内容

### 1. 安全防护增强 ✅

**问题**：全局中间件层面默认放开所有来源且允许携带凭证，缺少安全防护措施。

**优化措施**：
- ✅ 添加 `helmet` 中间件，增强 HTTP 安全头
- ✅ 添加 `express-rate-limit` 速率限制：
  - API 请求：15分钟内最多1000次
  - 登录接口：15分钟内最多20次尝试
- ✅ CORS 配置优化：
  - 支持通过环境变量 `ALLOWED_ORIGINS` 配置白名单（逗号分隔）
  - 开发环境默认允许所有来源，生产环境建议配置白名单
- ✅ 请求体大小限制：10MB

**配置说明**：
```env
# .env 文件
ALLOWED_ORIGINS=http://localhost:3000,https://yourdomain.com
```

**影响**：降低恶意请求、暴力破解和 DDoS 攻击风险。

---

### 2. KPI 计算规则统一 ✅

**问题**：销售场景下 `calculateCompletionFactorForSales` 永远返回 1，但单项目重算时使用了 `completionFactor`（受返修/延期/客诉影响），导致批量计算和单项目重算结果不一致。

**优化措施**：
- ✅ 统一使用 `calculateCompletionFactorForSales(project)` 函数
- ✅ 在 `generateMonthlyKPIRecords` 和 `generateProjectKPI` 中统一调用
- ✅ 添加详细的函数注释说明业务规则

**业务规则**：
- **销售 KPI**：
  - 完成系数固定为 1，不受返修/延期/客诉影响
  - 销售最终考核仅与回款相关
  - 通过返修率统计、流程考核等指标约束销售行为
- **PM KPI**：
  - 返修会影响 PM 的完成系数（每次返修减少 5%）
  - PM 负责人员安排和质量管控，返修会扣减 PM 的 KPI
- **其他生产人员 KPI**：
  - 返修会影响翻译、审校、排版的完成系数
  - 通过完成系数扣减机制，促使生产人员提高质量

**影响**：确保销售 KPI 计算的一致性，避免数据差异；明确各角色的责任和 KPI 影响规则。

---

### 3. 月度 KPI 生成并发保护 ✅

**问题**：月度 KPI 生成逐条查询项目成员并在不存在记录时直接插入，缺少幂等锁/去重和并发保护。

**优化措施**：
- ✅ 添加数据库唯一约束：
  - 复合唯一索引：`userId + projectId + month + role`
  - 确保同一用户在同一项目的同一月份同一角色只有一条记录
- ✅ 实现任务锁机制：
  - 使用内存 Map 存储任务锁
  - 防止同一月份并发计算
  - 自动释放超时锁（30分钟）
- ✅ 使用 upsert 模式：
  - 先查询是否存在记录
  - 存在且 `force=false` 时跳过
  - 存在且 `force=true` 时更新
  - 不存在时创建
- ✅ 处理唯一约束冲突：
  - 捕获并发插入导致的唯一约束冲突
  - 记录警告日志并继续处理

**函数签名变更**：
```javascript
// 新增 force 参数，支持强制重新计算
async function generateMonthlyKPIRecords(month, force = false)
```

**影响**：
- 防止重复计算和遗漏
- 提高批量任务稳定性
- 支持幂等操作

---

### 4. 项目创建接口输入校验增强 ✅

**问题**：项目创建接口仅做了必填校验与部分金额检查，尚未对成员数组、目标语言列表长度、金额上限等做输入限制，且更新字段白名单仍允许嵌套结构整体覆盖。

**优化措施**：

#### 4.1 基础字段校验
- ✅ 项目名称长度：2-200 个字符
- ✅ 目标语言列表：
  - 必须为数组
  - 数量限制：1-20 个
  - 自动去重
  - 验证每个语言项非空
- ✅ 成员数组：
  - 必须为数组格式
  - 数量限制：最多 50 个
  - 验证每个成员包含 `userId` 和 `role`
  - 验证角色枚举值
  - 验证 `wordRatio` 范围（0-10）

#### 4.2 金额校验
- ✅ 项目金额上限：1 亿
- ✅ 字数上限：1 亿字
- ✅ 单价上限：每千字 10 万
- ✅ 验证最终计算金额范围

#### 4.3 日期校验
- ✅ 验证交付时间格式
- ✅ 验证交付时间不能早于当前时间（可根据业务需求调整）

#### 4.4 兼职销售字段校验
- ✅ 公司应收金额：0 到项目总金额之间
- ✅ 税率：0-1 之间（0-100%）

#### 4.5 兼职排版字段校验
- ✅ 排版费用：非负数
- ✅ 排版费用不能超过项目总金额的 5%

#### 4.6 嵌套字段安全处理
- ✅ `specialRequirements` 字段逐项验证：
  - `terminology`、`nda`、`referenceFiles`：布尔值转换
  - `notes`：字符串，最大 500 字符
  - 防止整体覆盖导致的脏数据

**影响**：
- 防止无效数据入库
- 提高数据质量
- 增强系统稳定性

---

## 数据库变更

### KpiRecord 模型索引变更

**新增唯一约束**：
```javascript
// 复合唯一索引：确保幂等性
kpiRecordSchema.index({ 
  userId: 1, 
  projectId: 1, 
  month: 1, 
  role: 1 
}, { unique: true });
```

**注意**：如果数据库中已存在重复记录，需要先清理数据再应用此索引。

---

## 依赖变更

**新增依赖**：
- `helmet`: ^7.x
- `express-rate-limit`: ^7.x

**安装命令**：
```bash
npm install helmet express-rate-limit --save
```

---

## 环境变量配置

**新增可选配置**：
```env
# CORS 白名单（生产环境建议配置）
ALLOWED_ORIGINS=http://localhost:3000,https://yourdomain.com
```

---

## 测试建议

### 1. 安全防护测试
- [ ] 测试速率限制是否生效
- [ ] 测试 CORS 白名单配置
- [ ] 测试请求体大小限制

### 2. KPI 计算一致性测试
- [ ] 对比批量计算和单项目重算的销售 KPI 结果
- [ ] 验证销售 KPI 不受返修/延期/客诉影响（完成系数固定为 1）
- [ ] 验证返修会影响 PM 的 KPI（完成系数扣减）
- [ ] 验证返修会影响翻译/审校/排版的 KPI（完成系数扣减）

### 3. 并发保护测试
- [ ] 同时触发多次月度 KPI 计算，验证任务锁生效
- [ ] 验证唯一约束防止重复记录
- [ ] 测试 `force=true` 强制重新计算功能

### 4. 输入校验测试
- [ ] 测试各种边界值（金额上限、数组长度等）
- [ ] 测试无效输入（非数组、格式错误等）
- [ ] 测试嵌套字段安全处理

### 5. 返修业务逻辑测试
- [ ] 验证销售可以标记返修
- [ ] 验证 PM 可以标记返修
- [ ] 验证返修不影响销售 KPI
- [ ] 验证返修影响 PM 的 KPI
- [ ] 验证返修影响翻译/审校/排版的 KPI

---

## 回滚方案

如果优化后出现问题，可以：

1. **安全中间件**：临时注释 `helmet` 和 `rateLimit` 相关代码
2. **KPI 计算**：恢复使用 `completionFactor` 的旧逻辑
3. **并发保护**：移除任务锁和唯一约束（需删除索引）
4. **输入校验**：移除新增的校验逻辑

---

## 后续建议

1. **监控和日志**：
   - 添加速率限制触发日志
   - 记录 KPI 计算任务执行时间
   - 监控唯一约束冲突频率

2. **性能优化**：
   - 考虑批量插入 KPI 记录（使用 `insertMany`）
   - 优化月度 KPI 计算的查询性能

3. **业务规则文档化**：
   - 明确各角色 KPI 计算公式
   - 记录完成系数计算规则
   - 记录返修责任归属和 KPI 影响规则

4. **返修率统计功能**：
   - 实现销售返修率统计报表
   - 实现 PM 返修率统计报表
   - 用于流程考核和绩效评估

---

## 5. 返修业务逻辑优化 ✅

### 问题分析
返修可能由多种原因导致：
- PM 人员安排不当
- 翻译/审校/排版质量问题
- 销售在项目初期沟通、需求理解、客户管理等方面的问题

### 优化措施

#### 5.1 权限调整
- ✅ **返修标记权限**：PM、管理员、项目创建人（销售）都可以标记返修
- ✅ **业务逻辑**：销售需登记返修但不扣 KPI，通过其他指标（返修率统计、流程考核）约束销售行为

#### 5.2 KPI 影响规则
- ✅ **销售 KPI**：
  - 完成系数固定为 1，不受返修/延期/客诉影响
  - 销售 KPI 主要考核成交和回款
  - 通过返修率统计、流程考核等指标约束销售行为
- ✅ **PM KPI**：
  - 返修会影响 PM 的完成系数（每次返修减少 5%）
  - PM 负责人员安排和质量管控，返修会扣减 PM 的 KPI
- ✅ **其他生产人员 KPI**：
  - 返修会影响翻译、审校、排版的完成系数
  - 通过完成系数扣减机制，促使生产人员提高质量

#### 5.3 业务规则说明
在代码中添加了详细的业务规则注释：
- `calculateCompletionFactorForSales` 函数：说明销售完成系数固定为 1 的原因
- 返修标记路由：说明返修的责任归属和 KPI 影响规则

### 实现效果
- ✅ 销售可以标记返修，确保返修信息如实登记
- ✅ 返修不影响销售 KPI，避免销售因担心扣 KPI 而不登记
- ✅ 返修影响 PM 的 KPI，促使 PM 做好人员安排和质量管控
- ✅ 可通过返修率统计等指标进行流程考核，约束销售行为

---

---

## 更新日期

2024-12-19

