# 项目完整流程文档

根据 `workflow.txt` 梳理的完整项目流程。

## 📋 流程概览

```
0. 销售获取需求（业务前置）
   ↓
1. 销售创建项目（系统内流程开始，自动锁定KPI系数）
   ↓
2. PM添加成员 & 分配任务（项目状态：pending → in_progress）
   ↓
3. 项目执行（翻译 → 审校 → QC，PM记录质量信息）
   ↓
4. 项目完成（系统自动计算KPI）
   ↓
5. KPI结算（实时计算 + 月末批量计算）
```

---

## 🔵 第0阶段：销售获取客户需求（业务前置）

**角色：** 销售（BD/AM）

**获取信息：**
- 客户名称
- 翻译语言对
- 项目类型（MTPE / 深度编辑 / 审校项目）
- 字数 / 页面数
- 预估交付时间
- 项目金额
- 是否需要发票
- 特殊要求（术语表 / 保密协议 / 参考文件）

> ⚠️ 此阶段未进入系统，不涉及KPI。

---

## 🔵 第1阶段：销售创建项目（系统内流程开始）

**角色：** 销售（Sales）  
**系统逻辑：** 自动锁定KPI系数（核心）

### 步骤1.1：销售在系统中新建项目

**必填字段：**
- 项目名称
- 选择客户（从客户表选择）
- 项目金额（或字数和单价自动计算）
- 交付截止时间

**可选字段：**
- 项目编号（留空自动生成，格式：PRJ2024010001）
- 业务类型（笔译/口译/转录/本地化/其他）
- 项目类型（MTPE/深度编辑/审校项目/混合类型）- 仅笔译项目
- 翻译语言对（如：中英、英中、中日等）
- 字数（笔译项目）
- 单价（每千字，笔译项目）
- 是否含税
- 需要发票
- 特殊要求（术语表/保密协议/参考文件/备注）

**项目成员（可选）：**
- 可在创建时添加成员，也可后续添加
- 支持添加多个翻译、审校、PM等

### 步骤1.2：系统自动锁定KPI系数

系统从 `kpi_config` 表读取最新系数，包括：

| 字段 | 说明 |
|------|------|
| translator_mtpe | 翻译（MTPE）系数 |
| translator_deepedit | 翻译（深度编辑）系数 |
| reviewer | 审校系数 |
| pm | PM系数 |
| sales_bonus | 销售金额奖励系数 |
| sales_commission | 销售回款系数 |
| admin | 综合岗系数 |
| completion_factor | 完成系数标准 |

### 步骤1.3：系统将系数写入 `locked_ratios`

示例：
```json
{
  "translator_mtpe": 0.12,
  "translator_deepedit": 0.18,
  "reviewer": 0.08,
  "pm": 0.03,
  "sales_bonus": 0.02,
  "sales_commission": 0.10,
  "admin": 0.005,
  "completion_factor": 1.0
}
```

### 步骤1.4：项目创建成功

- 项目状态：`pending`（待开始）
- KPI系数已永久锁定，不可更改
- 🔒 **这是整个系统的最核心原则**

---

## 🔵 第2阶段：PM添加成员 & 分配任务

**角色：** PM（项目经理）

### 步骤2.1：PM添加参与成员

**可添加角色：**
- 翻译（可多个）
- 审校
- PM（自己）
- 销售（系统自动关联创建者）
- 综合岗（系统自动统计）

**添加方式：**
- 创建项目时添加
- 项目详情页面添加

### 步骤2.2：为翻译设置字数占比（如多人参与）

例如：

| 翻译人员 | 字数占比 |
|---------|---------|
| 张三 | 60% |
| 李四 | 40% |

此占比将在KPI结算时直接影响翻译绩效：

```
翻译KPI = 项目金额 × 翻译系数 × 字数占比 × 完成系数
```

### 步骤2.3：PM确认项目流程进入执行状态

**方式1：** 自动进入（添加成员后自动变为 `in_progress`）  
**方式2：** 手动开始（点击"开始项目"按钮）

- 项目状态：`pending` → `in_progress`（进行中）
- 记录开始时间：`startedAt`

---

## 🔵 第3阶段：项目执行（翻译 → 审校 → QC）

**角色：** 翻译、审校、PM

### 步骤3.1：翻译执行（MTPE or 深度编辑）

翻译上传：
- 译文文件
- 备注
- 术语问题（可选）

**产能记录：**
- 实际完成字数
- 实际工作小时（口译/转录项目）

### 步骤3.2：审校执行

审校上传最终交付版本。

**产能记录：**
- 实际完成字数
- 实际工作小时

### 步骤3.3：质量记录（由PM操作）

PM在系统中记录：

| 质量指标 | 说明 | 影响 |
|---------|------|------|
| 返修次数 | 0 / 1 / 2+ | 每次返修减少5%完成系数 |
| 是否延期 | 系统自动判断：交付时间 > deadline | 减少10%完成系数 |
| 是否客户投诉 | 是/否 | 减少20%完成系数 |

**系统自动生成完成系数：**

| 情况 | 系数计算 |
|------|---------|
| 正常 | 1.00 |
| 返修1次 | 0.95 |
| 返修2+次 | 0.90 |
| 延期 | ×0.90 |
| 客诉 | ×0.80 |

完成系数存入项目记录，用于KPI计算。

---

## 🔵 第4阶段：项目完成（进入KPI）

**角色：** PM or 系统自动

### 步骤4.1：PM点击"项目完成"

### 步骤4.2：系统检查以下条件

- ✅ 是否有成员（`hasMembers`）
- ✅ 项目金额是否填写完整（`hasAmount`）
- ✅ 质量信息是否填写（`hasQualityInfo`，可选）

### 步骤4.3：项目状态变为 `completed`

- 记录完成时间：`completedAt`
- 自动检查是否延期
- 项目进入KPI计算范围

### 步骤4.4：系统实时计算KPI（新增功能）

**计算逻辑：**
1. 获取项目完成月份
2. 遍历所有项目成员
3. 根据角色、字数占比、完成系数计算KPI
4. 立即生成KPI记录到 `kpi_records` 表

**KPI计算时机：**
- ✅ **实时计算**：项目完成时立即计算（推荐）
- ✅ **月末批量计算**：每月1日Cron任务计算上月完成的项目（备用）

---

## 🔵 第5阶段：KPI结算（自动化）

**角色：** 系统（cron job）或手动触发

### 步骤5.1：实时计算（项目完成时）

**逻辑：**
```
项目完成
  ↓
查找项目所有成员
  ↓
读取项目的 locked_ratios
  ↓
读取成员的角色 / 字数占比 / 完成系数
  ↓
计算单个成员KPI
  ↓
写入 kpi_records（月份 = 完成月份）
```

### 步骤5.2：月末批量计算（每月1日00:00）

**逻辑：**
```
查找所有上月完成的项目
  ↓
遍历每个项目
  ↓
检查是否已生成KPI（避免重复）
  ↓
为每个成员计算KPI
  ↓
写入 kpi_records
```

### 步骤5.3：系统生成"月度KPI明细 + 工资表"

**字段：**
- 用户名
- 角色
- 所属项目
- 项目金额（仅财务/管理员可见）
- 分成系数
- 完成系数
- KPI数值
- 合计KPI

### 步骤5.4：财务下载工资表（Excel）

- 支持导出月度汇总
- 支持导出用户明细
- 根据角色隐藏敏感信息

---

## 📊 完整端到端流程总结图

```
销售获取需求（业务前置）
   ↓
销售创建项目（锁定系数）✅
   ↓
PM添加翻译/审校/PM ✅
   ↓
项目开始执行（pending → in_progress）✅
   ↓
翻译执行 → 审校执行
   ↓
PM记录返修/延期/客诉（生成完成系数）✅
   ↓
PM标记项目完成 ✅
   ↓
系统实时计算KPI ✅
   ↓
财务导出KPI工资表 ✅
```

---

## 🔑 核心原则

1. **比例锁定机制**：项目创建时锁定KPI系数，历史项目不受配置变更影响
2. **实时计算**：项目完成时立即计算KPI，无需等到月末
3. **质量影响**：返修、延期、客诉自动影响完成系数
4. **权限控制**：敏感角色（PM、翻译、审校）不能查看项目金额
5. **一人多岗**：支持同一员工在不同项目中担任不同角色

---

## 🎯 状态流转

```
pending（待开始）
   ↓ [PM添加成员 或 点击开始项目]
in_progress（进行中）
   ↓ [PM标记完成]
completed（已完成）
   ↓ [系统自动计算KPI]
KPI记录生成
```

---

## 📝 数据完整性检查

项目完成前系统会检查：
- ✅ 是否有成员
- ✅ 项目金额是否填写
- ✅ 质量信息是否填写（可选，但建议填写）

---

## 🔄 KPI计算模式

### 模式1：实时计算（推荐）
- **触发时机**：项目完成时
- **优点**：立即看到KPI，无需等待
- **适用场景**：日常项目管理

### 模式2：月末批量计算
- **触发时机**：每月1日00:00（Cron任务）
- **优点**：统一计算，避免遗漏
- **适用场景**：月度工资结算

**两种模式可以并存，系统会自动避免重复计算。**

---

## 📌 注意事项

1. **项目编号**：建议使用自动生成，确保唯一性
2. **成员分配**：必须在项目完成前完成
3. **质量记录**：建议及时记录返修、延期、客诉信息
4. **KPI查看**：翻译、审校、PM只能查看自己的KPI，且不显示项目金额
5. **历史数据**：已完成的项目的KPI不会因配置变更而改变

---

## 🚀 使用建议

1. **销售**：创建项目时尽量填写完整信息，可同时添加成员
2. **PM**：及时添加成员，记录质量信息，项目完成后立即查看KPI
3. **翻译/审校**：项目完成后即可查看自己的KPI
4. **财务**：月末导出工资表，审核KPI记录

---

**最后更新：** 根据 workflow.txt 完善后的完整流程

































