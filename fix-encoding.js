const fs = require('fs');

let content = fs.readFileSync('public/app.js', 'utf8');

// 使用 \uFFFD (Unicode 替换字符) 来匹配所有乱码
// 修复字符串中的乱码
const fixes = [
    // 修复常见的字符串乱码
    [/语种已创[\uFFFD]+/g, '语种已创建'],
    [/语种已更[\uFFFD]+/g, '语种已更新'],
    [/用户已删[\uFFFD]+/g, '用户已删除'],
    [/客户已删[\uFFFD]+/g, '客户已删除'],
    [/客户不存[\uFFFD]+/g, '客户不存在'],
    [/无权限访问财务模[\uFFFD]+/g, '无权限访问财务模块'],
    [/成交额趋势（[\uFFFD]+个月[\uFFFD]+/g, '成交额趋势（近3个月）'],
    [/KPI趋势（近3个月[\uFFFD]+/g, 'KPI趋势（近3个月）'],
    
    // 修复注释中的乱码
    [/\/\/ KPI\/成交额趋[\uFFFD]+\- 折线[\uFFFD]+\s+const trend/g, '// KPI/成交额趋势 - 折线图\n    const trend'],
    [/\/\/ 移除所有卡片的active状[\uFFFD]+/g, '// 移除所有卡片的active状态'],
    [/\/\/ 添加选中卡片的active状[\uFFFD]+/g, '// 添加选中卡片的active状态'],
    [/\/\/ 如果数据还没加载，重新加载[\uFFFD]+/g, '// 如果数据还没加载，重新加载'],
    [/\/\/ 销售从看板跳转进入，只读视图[\uFFFD]+/g, '// 销售从看板跳转进入，只读视图'],
    [/\/\/ 切换到其他模块时关闭销售财务视图[\uFFFD]+/g, '// 切换到其他模块时关闭销售财务视图'],
    [/\/\/ 显示切换器[\uFFFD]+/g, '// 显示切换器'],
    [/\/\/ 根据当前角色权限显示\/隐藏菜单[\uFFFD]+/g, '// 根据当前角色权限显示/隐藏菜单'],
    [/\/\/ 初始化当前角色[\uFFFD]+/g, '// 初始化当前角色'],
    [/\/\/ 如果没有默认角色，使用第一个角色[\uFFFD]+/g, '// 如果没有默认角色，使用第一个角色'],
    [/\/\/ 强制回到登录页（清除可能残留[\uFFFD]+ 查询[\uFFFD]+/g, '// 强制回到登录页（清除可能残留的查询）'],
    [/\/\/ 根据当前角色显示菜单（保留旧逻辑作为fallback[\uFFFD]+/g, '// 根据当前角色显示菜单（保留旧逻辑作为fallback）'],
    [/\/\/ 先加载用户列表（用于下拉选择[\uFFFD]+/g, '// 先加载用户列表（用于下拉选择）'],
    [/\/\/ 销售和兼职销售也需要加载用户列表（用于创建项目时选择成员[\uFFFD]+/g, '// 销售和兼职销售也需要加载用户列表（用于创建项目时选择成员）'],
    [/\/\/ 财务筛选下拉需要客户[\uFFFD]+销售[\uFFFD]+/g, '// 财务筛选下拉需要客户、销售'],
    [/\/\/ 不再需要填充下拉框，改为使用搜索选择[\uFFFD]+/g, '// 不再需要填充下拉框，改为使用搜索选择'],
    [/\/\/ 确保项目列表已加[\uFFFD]+/g, '// 确保项目列表已加载'],
    [/\/\/ 交付逾期，倾向于查看进行中\/待开始[\uFFFD]+/g, '// 交付逾期，倾向于查看进行中/待开始'],
    [/\/\/ 允许销售只读访问[\uFFFD]+/g, '// 允许销售只读访问'],
    [/\/\/ 不在未登录状态直接弹窗，要求重新登录后再改密码[\uFFFD]+/g, '// 不在未登录状态直接弹窗，要求重新登录后再改密码'],
    
    // 修复其他常见乱码
    [/状[\uFFFD]+/g, '状态'],
    [/用户[\uFFFD]+/g, '用户名'],
    [/联系[\uFFFD]+/g, '联系人'],
    [/简[\uFFFD]+/g, '简称'],
    [/激[\uFFFD]+/g, '激活'],
    [/禁[\uFFFD]+/g, '禁用'],
    [/删[\uFFFD]+/g, '删除'],
    [/创[\uFFFD]+/g, '创建'],
    [/更[\uFFFD]+/g, '更新'],
    [/销[\uFFFD]+/g, '销售'],
    [/加载[\uFFFD]+/g, '加载中'],
    [/上一[\uFFFD]+/g, '上一页'],
    [/下一[\uFFFD]+/g, '下一页'],
    [/全部销[\uFFFD]+/g, '全部销售'],
    [/全部状[\uFFFD]+/g, '全部状态'],
    [/待开[\uFFFD]+/g, '待开始'],
    [/进行[\uFFFD]+/g, '进行中'],
    [/已完[\uFFFD]+/g, '已完成'],
    [/请至少选择一个角[\uFFFD]+/g, '请至少选择一个角色'],
    [/兼容[\uFFFD]+/g, '兼容性'],
    [/换行[\uFFFD]+/g, '换行符'],
    [/乱[\uFFFD]+/g, '乱码'],
    [/包含销售和兼职销[\uFFFD]+/g, '包含销售和兼职销售'],
    [/如果用户列表还没加载，显示提[\uFFFD]+/g, '如果用户列表还没加载，显示提示'],
    [/加载中[\uFFFD]+\.\./g, '加载中...'],
    [/\/\/ 包含销售和兼职销售[\uFFFD]+\s+const/g, '// 包含销售和兼职销售\n        const'],
    [/注意：此函数使用UTF-8 BOM，但Excel可能仍显示乱[\uFFFD]+/g, '注意：此函数使用UTF-8 BOM，但Excel可能仍显示乱码'],
    [/建议使用后端API导出（GBK编码）以获得更好的兼容[\uFFFD]+/g, '建议使用后端API导出（GBK编码）以获得更好的兼容性'],
    [/如：中文、英[\uFFFD]+/g, '如：中文、英文'],
    [/锁定筛选：销售只能看自己创建的项目[\uFFFD]+/g, '锁定筛选：销售只能看自己创建的项目'],
];

fixes.forEach(([pattern, replacement]) => {
    content = content.replace(pattern, replacement);
});

fs.writeFileSync('public/app.js', content, 'utf8');
console.log('Fixed encoding issues using \\uFFFD');
